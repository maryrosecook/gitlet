<!DOCTYPE html>

<html>
<head>
  <title>gitlet.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>gitlet.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>#!<span class="hljs-regexp">/usr/</span>bin/env node</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p><a href="/">Home</a> |
<a href="https://github.com/maryrosecook/gitlet">GitHub</a></p>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h2 id="introduction">Introduction</h2>

            </div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>This code is intended to show how Git works under the covers.  It
is written to be readable.  It is heavily commented.</p>

            </div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>If you would like to understand what happens when you run the basic
Git commands, you can read the short essay below.</p>

            </div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <h2 id="git-in-six-hundred-words">Git in six hundred words</h2>

            </div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Imagine you have a directory called <code>alpha</code>. It contains a file
called <code>number.txt</code> that contains the text <code>first</code>.</p>

            </div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>You run <code>git init</code> to set up <code>alpha</code> as a Git repository.</p>

            </div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>You run <code>git add number.txt</code> to add <code>number.txt</code> to the index. The
index is a list of all the files that Git is keeping track of. It
maps filenames to the content of the files. It now has the mapping
<code>number.txt -&gt; first</code>. Running the add command has also added a
blob object containing <code>first</code> to the Git object database.</p>

            </div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>You run <code>git commit -m first</code>. This does three things. First, it
creates a tree object in the objects database. This object
represents the list of items in the top level of the alpha
directory. This object has a pointer to the <code>first</code> blob object
that was created when you ran <code>git add</code>. Second, it creates a
commit object that represents the version of the repository that
you have just committed. This includes a pointer to the tree
object. Third, it points the master branch at the new commit
object.</p>

            </div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>You run <code>git clone . ../beta</code>. This creates a new directory called
<code>beta</code>. It initializes it as a Git repository. It copies the
objects in the alpha objects database to the beta objects
database. It points the master branch on beta at the commit object
that the master branch points at on the alpha repository. It sets
the index on beta to mirror the content of the first commit. It
updates your files - <code>number.txt</code> - to mirror the index.</p>

            </div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>You move to the beta repository. You change the content of
<code>number.txt</code> to <code>second</code>. You run <code>git add number.txt</code> and <code>git
commit -m second</code>. The commit object that is created has a pointer
to its parent, the first commit.  The commit command points the
master branch at the second commit.</p>

            </div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>You move back to the alpha repository. You run <code>git remote add beta
../beta</code>. This sets the beta repository as a remote repository.</p>

            </div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>You run <code>git pull beta master</code>.</p>

            </div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Under the covers, this runs <code>git fetch beta master</code>. This finds the
objects for the second commit and copies them from the beta
repository to the alpha repository. It points alpha’s record of
beta’s master at the second commit object. It updates <code>FETCH_HEAD</code>
to show that the master branch was fetched from the beta
repository.</p>

            </div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Under the covers, the pull command runs <code>git merge
FETCH_HEAD</code>. This reads <code>FETCH_HEAD</code>, which shows that the master
branch on the beta repository was the most recently fetched
branch. It gets the commit object that alpha’s record of beta’s
master is pointing at. This is the second commit. The master branch
on alpha is pointing at the first commit, which is the ancestor of
the second commit. This means that, to complete the merge, the
merge command can just point the master branch at the second
commit. The merge command updates the index to mirror the contents
of the second commit. It updates the working copy to mirror the
index.</p>

            </div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>You run <code>git branch red</code>. This creates a branch called <code>red</code> that
points at the second commit object.</p>

            </div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>You run <code>git checkout red</code>. Before the checkout, <code>HEAD</code> pointed at
the master branch. It now points at the red branch. This makes the
red branch the current branch.</p>

            </div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>You set the content of <code>number.txt</code> to <code>third</code>, run <code>git add
numbers.txt</code> and run <code>git commit -m third</code>.</p>

            </div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>You run <code>git push beta red</code>. This finds the objects for the third
commit and copies them from the alpha repository to the beta
repository. It points the red branch on the beta repository at the
third commit object, and that’s it.</p>

            </div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <h2 id="imports">Imports</h2>

            </div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">"fs"</span>);
<span class="hljs-keyword">var</span> nodePath = <span class="hljs-built_in">require</span>(<span class="hljs-string">"path"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <h2 id="main-git-api-functions">Main Git API functions</h2>

            </div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">var</span> gitlet = module.exports = {</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p><strong>init()</strong> initializes the current directory as a new repository.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(opts)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Abort if already a repository.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (files.inRepo()) { <span class="hljs-keyword">return</span>; }

    opts = opts || {};</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Create a JS object that mirrors the Git basic directory
structure.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> gitletStructure = {
      HEAD: <span class="hljs-string">"ref: refs/heads/master\n"</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>If <code>--bare</code> was passed, write to the Git config indicating
that the repository is bare.  If <code>--bare</code> was not passed,
write to the Git config saying the repository is not bare.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      config: config.objToStr({ core: { <span class="hljs-string">""</span>: { bare: opts.bare === <span class="hljs-literal">true</span> }}}),

      objects: {},
      refs: {
        heads: {},
      }
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Write the standard Git directory structure using the
<code>gitletStructure</code> JS object.  If the repository is not bare,
put the directories inside the <code>.gitlet</code> directory.  If the
repository is bare, put them in the top level of the
repository.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    files.writeFilesFromTree(opts.bare ? gitletStructure : { <span class="hljs-string">".gitlet"</span>: gitletStructure },
                             process.cwd());
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p><strong>add()</strong> adds files that match <code>path</code> to the index.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  add: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path, _)</span> {</span>
    files.assertInRepo();
    config.assertNotBare();</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Get the paths of all the files matching <code>path</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> addedFiles = files.lsRecursive(path);</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Abort if no files matched <code>path</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (addedFiles.length === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(files.pathFromRepoRoot(path) + <span class="hljs-string">" did not match any files"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Otherwise, use the <code>update_index()</code> Git command to actually add
the files.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    } <span class="hljs-keyword">else</span> {
      addedFiles.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(p)</span> {</span> gitlet.update_index(p, { add: <span class="hljs-literal">true</span> }); });
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p><strong>rm()</strong> removes files that match <code>path</code> from the index.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  rm: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path, opts)</span> {</span>
    files.assertInRepo();
    config.assertNotBare();
    opts = opts || {};</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Get the paths of all files in the index that match <code>path</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> filesToRm = index.matchingFiles(path);</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Abort if <code>-f</code> was passed. The removal of files with changes is
not supported.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (opts.f) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"unsupported"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>Abort if no files matched <code>path</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (filesToRm.length === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(files.pathFromRepoRoot(path) + <span class="hljs-string">" did not match any files"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Abort if <code>path</code> is a directory and <code>-r</code> was not passed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fs.existsSync(path) &amp;&amp; fs.statSync(path).isDirectory() &amp;&amp; !opts.r) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"not removing "</span> + path + <span class="hljs-string">" recursively without -r"</span>);

    } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Get a list of all files that are to be removed and have also
been changed on disk.  If this list is not empty then abort.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> changesToRm = util.intersection(diff.addedOrModifiedFiles(), filesToRm);
      <span class="hljs-keyword">if</span> (changesToRm.length &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"these files have changes:\n"</span> + changesToRm.join(<span class="hljs-string">"\n"</span>) + <span class="hljs-string">"\n"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>Otherwise, remove the files that match <code>path</code>. Delete them
from disk and remove from the index.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      } <span class="hljs-keyword">else</span> {
        filesToRm.map(files.workingCopyPath).filter(fs.existsSync).forEach(fs.unlinkSync);
        filesToRm.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(p)</span> {</span> gitlet.update_index(p, { remove: <span class="hljs-literal">true</span> }); });
      }
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p><strong>commit()</strong> creates a commit object that represents the current
state of the index, writes the commit to the <code>objects</code> directory
and points <code>HEAD</code> at the commit.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  commit: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(opts)</span> {</span>
    files.assertInRepo();
    config.assertNotBare();</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Write a tree object that represents the current state of the
index.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> treeHash = <span class="hljs-keyword">this</span>.write_tree();

    <span class="hljs-keyword">var</span> headDesc = refs.isHeadDetached() ? <span class="hljs-string">"detached HEAD"</span> : refs.headBranchName();</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>If the hash of the new tree is the same as the hash of the tree
that the <code>HEAD</code> commit points at, abort because there is
nothing new to commit.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (refs.hash(<span class="hljs-string">"HEAD"</span>) !== <span class="hljs-literal">undefined</span> &amp;&amp;
        treeHash === objects.treeHash(objects.read(refs.hash(<span class="hljs-string">"HEAD"</span>)))) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"# On "</span> + headDesc + <span class="hljs-string">"\nnothing to commit, working directory clean"</span>);

    } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>Abort if the repository is in the merge state and there are
unresolved merge conflicts.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> conflictedPaths = index.conflictedPaths();
      <span class="hljs-keyword">if</span> (merge.isMergeInProgress() &amp;&amp; conflictedPaths.length &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(conflictedPaths.map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(p)</span> {</span> <span class="hljs-keyword">return</span> <span class="hljs-string">"U "</span> + p; }).join(<span class="hljs-string">"\n"</span>) +
                        <span class="hljs-string">"\ncannot commit because you have unmerged files\n"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>Otherwise, do the commit.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>If the repository is in the merge state, use a pre-written
merge commit message.  If the repository is not in the
merge state, use the message passed with <code>-m</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> m = merge.isMergeInProgress() ? files.read(files.gitletPath(<span class="hljs-string">"MERGE_MSG"</span>)) : opts.m</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>Write the new commit to the <code>objects</code> directory.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> commitHash = objects.writeCommit(treeHash, m, refs.commitParentHashes());</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>Point <code>HEAD</code> at new commit.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.update_ref(<span class="hljs-string">"HEAD"</span>, commitHash);</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>If <code>MERGE_HEAD</code> exists, the repository was in the merge
state. Remove <code>MERGE_HEAD</code> and <code>MERGE_MSG</code>to exit the merge
state.  Report that the merge is complete.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (merge.isMergeInProgress()) {
          fs.unlinkSync(files.gitletPath(<span class="hljs-string">"MERGE_MSG"</span>));
          refs.rm(<span class="hljs-string">"MERGE_HEAD"</span>);
          <span class="hljs-keyword">return</span> <span class="hljs-string">"Merge made by the three-way strategy"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>Repository was not in the merge state, so just report that
the commit is complete.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">return</span> <span class="hljs-string">"["</span> + headDesc + <span class="hljs-string">" "</span> + commitHash + <span class="hljs-string">"] "</span> + m;
        }
      }
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p><strong>branch()</strong> creates a new branch that points at the commit that
<code>HEAD</code> points at.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  branch: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name, opts)</span> {</span>
    files.assertInRepo();
    opts = opts || {};</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>If no branch <code>name</code> was passed, list the local branches.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (name === <span class="hljs-literal">undefined</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.keys(refs.localHeads()).map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(branch)</span> {</span>
        <span class="hljs-keyword">return</span> (branch === refs.headBranchName() ? <span class="hljs-string">"* "</span> : <span class="hljs-string">"  "</span>) + branch;
      }).join(<span class="hljs-string">"\n"</span>) + <span class="hljs-string">"\n"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p><code>HEAD</code> is not pointing at a commit, so there is no commit for
the new branch to point at.  Abort.  This is most likely to
happen if the repository has no commits.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (refs.hash(<span class="hljs-string">"HEAD"</span>) === <span class="hljs-literal">undefined</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(refs.headBranchName() + <span class="hljs-string">" not a valid object name"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>Abort because a branch called <code>name</code> already exists.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (refs.exists(refs.toLocalRef(name))) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"A branch named "</span> + name + <span class="hljs-string">" already exists"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>Otherwise, create a new branch by creating a new file called
<code>name</code> that contains the hash of the commit that <code>HEAD</code> points
at.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">this</span>.update_ref(refs.toLocalRef(name), refs.hash(<span class="hljs-string">"HEAD"</span>));
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p><strong>checkout()</strong> changes the index, working copy and <code>HEAD</code> to
reflect the content of <code>ref</code>.  <code>ref</code> might be a branch name or a
commit hash.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  checkout: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(ref, _)</span> {</span>
    files.assertInRepo();
    config.assertNotBare();</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>Get the hash of the commit to check out.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> toHash = refs.hash(ref);</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>Abort if <code>ref</code> cannot be found.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!objects.exists(toHash)) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(ref + <span class="hljs-string">" did not match any file(s) known to Gitlet"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>Abort if the hash to check out points to an object that is a
not a commit.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (objects.type(objects.read(toHash)) !== <span class="hljs-string">"commit"</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"reference is not a tree: "</span> + ref);</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>Abort if <code>ref</code> is the name of the branch currently checked out.
Abort if head is detached, <code>ref</code> is a commit hash and <code>HEAD</code> is
pointing at that hash.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ref === refs.headBranchName() ||
               ref === files.read(files.gitletPath(<span class="hljs-string">"HEAD"</span>))) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">"Already on "</span> + ref;
    } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>Get a list of files changed in the working copy.  Get a list
of the files that are different in the head commit and the
commit to check out.  If any files appear in both lists then
abort.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> paths = diff.changedFilesCommitWouldOverwrite(toHash);
      <span class="hljs-keyword">if</span> (paths.length &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"local changes would be lost\n"</span> + paths.join(<span class="hljs-string">"\n"</span>) + <span class="hljs-string">"\n"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>Otherwise, perform the checkout.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      } <span class="hljs-keyword">else</span> {
        process.chdir(files.workingCopyPath());</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>If the ref is in the <code>objects</code> directory, it must be a hash
and so this checkout is detaching the head.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> isDetachingHead = objects.exists(ref);</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>Get the list of differences between the current commit and
the commit to check out.  Write them to the working copy.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        workingCopy.write(diff.diff(refs.hash(<span class="hljs-string">"HEAD"</span>), toHash));</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>Write the commit being checked out to <code>HEAD</code>. If the head
is being detached, the commit hash is written directly to
the <code>HEAD</code> file.  If the head is not being detached, the
branch being checked out is written to <code>HEAD</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        refs.write(<span class="hljs-string">"HEAD"</span>, isDetachingHead ? toHash : <span class="hljs-string">"ref: "</span> + refs.toLocalRef(ref));</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>Set the index to the contents of the commit being checked
out.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        index.write(index.tocToIndex(objects.commitToc(toHash)));</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>Report the result of the checkout.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">return</span> isDetachingHead ?
          <span class="hljs-string">"Note: checking out "</span> + toHash + <span class="hljs-string">"\nYou are in detached HEAD state."</span> :
          <span class="hljs-string">"Switched to branch "</span> + ref;
      }
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p><strong>diff()</strong> shows the changes required to go from the <code>ref1</code>
commit to the <code>ref2</code> commit.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  diff: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(ref1, ref2, opts)</span> {</span>
    files.assertInRepo();
    config.assertNotBare();</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>Abort if <code>ref1</code> was supplied, but it does not resolve to a
hash.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (ref1 !== <span class="hljs-literal">undefined</span> &amp;&amp; refs.hash(ref1) === <span class="hljs-literal">undefined</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"ambiguous argument "</span> + ref1 + <span class="hljs-string">": unknown revision"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>Abort if <code>ref2</code> was supplied, but it does not resolve to a
hash.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ref2 !== <span class="hljs-literal">undefined</span> &amp;&amp; refs.hash(ref2) === <span class="hljs-literal">undefined</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"ambiguous argument "</span> + ref2 + <span class="hljs-string">": unknown revision"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>Otherwise, perform diff.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>Gitlet only shows the name of each changed file and whether
it was added, modified or deleted.  For simplicity, the
changed content is not shown.</p>

            </div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>The diff happens between two versions of the repository.  The
first version is either the hash that <code>ref1</code> resolves to, or
the index.  The second version is either the hash that <code>ref2</code>
resolves to, or the working copy.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> nameToStatus = diff.nameStatus(diff.diff(refs.hash(ref1), refs.hash(ref2)));</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>Show the path of each changed file.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.keys(nameToStatus)
        .map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path)</span> {</span> <span class="hljs-keyword">return</span> nameToStatus[path] + <span class="hljs-string">" "</span> + path; })
        .join(<span class="hljs-string">"\n"</span>) + <span class="hljs-string">"\n"</span>;
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p><strong>remote()</strong> records the locations of remote versions of this
repository.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  remote: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(command, name, path, _)</span> {</span>
    files.assertInRepo();</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>Abort if <code>command</code> is not “add”.  Only “add” is supported.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (command !== <span class="hljs-string">"add"</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"unsupported"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>Abort if repository already has a record for a remote called
<code>name</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (name <span class="hljs-keyword">in</span> config.read()[<span class="hljs-string">"remote"</span>]) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"remote "</span> + name + <span class="hljs-string">" already exists"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p>Otherwise, add remote record.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>Write to the config file a record of the <code>name</code> and <code>path</code> of
the remote.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      config.write(util.setIn(config.read(), [<span class="hljs-string">"remote"</span>, name, <span class="hljs-string">"url"</span>, path]));
      <span class="hljs-keyword">return</span> <span class="hljs-string">"\n"</span>;
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p><strong>fetch()</strong> records the commit that <code>branch</code> is at on <code>remote</code>.
It does not change the local branch.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  fetch: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(remote, branch, _)</span> {</span>
    files.assertInRepo();</pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p>Abort if a <code>remote</code> or <code>branch</code> not passed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (remote === <span class="hljs-literal">undefined</span> || branch === <span class="hljs-literal">undefined</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"unsupported"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p>Abort if <code>remote</code> not recorded in config file.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!(remote <span class="hljs-keyword">in</span> config.read().remote)) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(remote + <span class="hljs-string">" does not appear to be a git repository"</span>);

    } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p>Get the location of the remote.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> remoteUrl = config.read().remote[remote].url;</pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <p>Turn the unqualified branch name into a qualified remote ref
eg <code>[branch] -&gt; refs/remotes/[remote]/[branch]</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> remoteRef =  refs.toRemoteRef(remote, branch);</pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <p>Go to the remote repository and get the hash of the commit
that <code>branch</code> is on.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> newHash = util.remote(remoteUrl)(refs.hash, branch);</pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <p>Abort if <code>branch</code> did not exist on the remote.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (newHash === <span class="hljs-literal">undefined</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"couldn't find remote ref "</span> + branch);</pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <p>Otherwise, perform the fetch.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <p>Note down the hash of the commit this repository currently
thinks the remote branch is on.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> oldHash = refs.hash(remoteRef);</pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <p>Get all the objects in the remote <code>objects</code> directory and
write them.  to the local <code>objects</code> directory.  (This is an
inefficient way of getting all the objects required to
recreate locally the commit the remote branch is on.)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> remoteObjects = util.remote(remoteUrl)(objects.allObjects);
        remoteObjects.forEach(objects.write);</pre></div></div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              <p>Set the contents of the file at
<code>.gitlet/refs/remotes/[remote]/[branch]</code> to <code>newHash</code>, the
hash of the commit that the remote branch is on.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        gitlet.update_ref(remoteRef, newHash);</pre></div></div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              <p>Record the hash of the commit that the remote branch is on
in <code>FETCH_HEAD</code>.  (The user can call <code>gitlet merge
FETCH_HEAD</code> to merge the remote version of the branch into
their local branch.  For more details, see
<a href="#section-93">gitlet.merge()</a>.)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        refs.write(<span class="hljs-string">"FETCH_HEAD"</span>, newHash + <span class="hljs-string">" branch "</span> + branch + <span class="hljs-string">" of "</span> + remoteUrl);</pre></div></div>
            
        </li>
        
        
        <li id="section-94">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-94">&#182;</a>
              </div>
              <p>Report the result of the fetch.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">return</span> [<span class="hljs-string">"From "</span> + remoteUrl,
                <span class="hljs-string">"Count "</span> + remoteObjects.length,
                branch + <span class="hljs-string">" -&gt; "</span> + remote + <span class="hljs-string">"/"</span> + branch +
                (merge.isAForceFetch(oldHash, newHash) ? <span class="hljs-string">" (forced)"</span> : <span class="hljs-string">""</span>)].join(<span class="hljs-string">"\n"</span>) + <span class="hljs-string">"\n"</span>;
      }
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-95">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-95">&#182;</a>
              </div>
              <p><strong>merge()</strong> finds the set of differences between the commit that
the currently checked out branch is on and the commit that <code>ref</code>
points to.  It finds or creates a commit that applies these
differences to the checked out branch.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  merge: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(ref, _)</span> {</span>
    files.assertInRepo();
    config.assertNotBare();</pre></div></div>
            
        </li>
        
        
        <li id="section-96">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-96">&#182;</a>
              </div>
              <p>Get the <code>receiverHash</code>, the hash of the commit that thet
current branch is on.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> receiverHash = refs.hash(<span class="hljs-string">"HEAD"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-97">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-97">&#182;</a>
              </div>
              <p>Get the <code>giverHash</code>, the hash for the commit to merge into the
receiver commit.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> giverHash = refs.hash(ref);</pre></div></div>
            
        </li>
        
        
        <li id="section-98">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-98">&#182;</a>
              </div>
              <p>Abort if head is detached.  Merging into a detached head is not
supported.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (refs.isHeadDetached()) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"unsupported"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-99">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-99">&#182;</a>
              </div>
              <p>Abort if <code>ref</code> did not resolve to a hash, or if that hash is
not for a commit object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (giverHash === <span class="hljs-literal">undefined</span> || objects.type(objects.read(giverHash)) !== <span class="hljs-string">"commit"</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(ref + <span class="hljs-string">": expected commit type"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-100">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-100">&#182;</a>
              </div>
              <p>Do not merge if the current branch - the receiver - already has
the giver’s changes.  This is the case if the receiver and
giver are the same commit, or if the giver is an ancestor of
the receiver.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (objects.isUpToDate(receiverHash, giverHash)) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">"Already up-to-date"</span>;

    } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-101">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-101">&#182;</a>
              </div>
              <p>Get a list of files changed in the working copy.  Get a list
of the files that are different in the receiver and giver. If
any files appear in both lists then abort.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> paths = diff.changedFilesCommitWouldOverwrite(giverHash);
      <span class="hljs-keyword">if</span> (paths.length &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"local changes would be lost\n"</span> + paths.join(<span class="hljs-string">"\n"</span>) + <span class="hljs-string">"\n"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-102">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-102">&#182;</a>
              </div>
              <p>If the receiver is an ancestor of the giver, a fast forward
is performed.  This is possible because there is already a
commit that incorporates all of the giver’s changes into the
receiver.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (merge.canFastForward(receiverHash, giverHash)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-103">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-103">&#182;</a>
              </div>
              <p>Fast forwarding means making the current branch reflect the
commit that <code>giverHash</code> points at.  The branch is pointed
at <code>giverHash</code>.  The index is set to match the contents of
the commit that <code>giverHash</code> points at.  The working copy is
set to match the contents of that commit.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        merge.writeFastForwardMerge(receiverHash, giverHash);
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Fast-forward"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-104">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-104">&#182;</a>
              </div>
              <p>If the receiver is not an ancestor of the giver, a merge
commit must be created.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-105">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-105">&#182;</a>
              </div>
              <p>The repository is put into the merge state.  The
<code>MERGE_HEAD</code> file is written and its contents set to
<code>giverHash</code>.  The <code>MERGE_MSG</code> file is written and its
contents set to a boilerplate merge commit message.  A
merge diff is created that will turn the contents of
receiver into the contents of giver.  This contains the
path of every file that is different and whether it was
added, removed or modified, or is in conflict.  Added files
are added to the index and working copy.  Removed files are
removed from the index and working copy.  Modified files
are modified in the index and working copy.  Files that are
in conflict are written to the working copy to include the
receiver and giver versions.  Both the receiver and giver
versions are written to the index.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        merge.writeNonFastForwardMerge(receiverHash, giverHash, ref);</pre></div></div>
            
        </li>
        
        
        <li id="section-106">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-106">&#182;</a>
              </div>
              <p>If there are any conflicted files, a message is shown to
say that the user must sort them out before the merge can
be completed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (merge.hasConflicts(receiverHash, giverHash)) {
          <span class="hljs-keyword">return</span> <span class="hljs-string">"Automatic merge failed. Fix conflicts and commit the result."</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-107">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-107">&#182;</a>
              </div>
              <p>If there are no conflicted files, a commit is created from
the merged changes and the merge is over.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.commit();
        }
      }
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-108">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-108">&#182;</a>
              </div>
              <p><strong>pull()</strong> fetches the commit that <code>branch</code> is on at <code>remote</code>.
It merges that commit into the current branch.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  pull: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(remote, branch, _)</span> {</span>
    files.assertInRepo();
    config.assertNotBare();
    <span class="hljs-keyword">this</span>.fetch(remote, branch);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.merge(<span class="hljs-string">"FETCH_HEAD"</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-109">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-109">&#182;</a>
              </div>
              <p><strong>push()</strong> gets the commit that <code>branch</code> is on in the local repo
and points <code>branch</code> on <code>remote</code> at the same commit.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  push: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(remote, branch, opts)</span> {</span>
    files.assertInRepo();
    opts = opts || {};</pre></div></div>
            
        </li>
        
        
        <li id="section-110">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-110">&#182;</a>
              </div>
              <p>Abort if a <code>remote</code> or <code>branch</code> not passed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (remote === <span class="hljs-literal">undefined</span> || branch === <span class="hljs-literal">undefined</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"unsupported"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-111">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-111">&#182;</a>
              </div>
              <p>Abort if <code>remote</code> not recorded in config file.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!(remote <span class="hljs-keyword">in</span> config.read().remote)) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(remote + <span class="hljs-string">" does not appear to be a git repository"</span>);

    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">var</span> remotePath = config.read().remote[remote].url;
      <span class="hljs-keyword">var</span> remoteCall = util.remote(remotePath);</pre></div></div>
            
        </li>
        
        
        <li id="section-112">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-112">&#182;</a>
              </div>
              <p>Abort if remote repository is not bare and <code>branch</code> is
checked out.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (remoteCall(refs.isCheckedOut, branch)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"refusing to update checked out branch "</span> + branch);

      } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-113">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-113">&#182;</a>
              </div>
              <p>Get <code>receiverHash</code>, the hash of the commit that <code>branch</code> is
on at <code>remote</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> receiverHash = remoteCall(refs.hash, branch);</pre></div></div>
            
        </li>
        
        
        <li id="section-114">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-114">&#182;</a>
              </div>
              <p>Get <code>giverHash</code>, the hash of the commit that <code>branch</code> is on
at the local repository.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> giverHash = refs.hash(branch);</pre></div></div>
            
        </li>
        
        
        <li id="section-115">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-115">&#182;</a>
              </div>
              <p>Do nothing if the remote branch - the receiver - has
already incorporated the commit that <code>giverHash</code> points
to. This is the case if the receiver commit and giver
commit are the same, or if the giver commit is an ancestor
of the receiver commit.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (objects.isUpToDate(receiverHash, giverHash)) {
          <span class="hljs-keyword">return</span> <span class="hljs-string">"Already up-to-date"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-116">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-116">&#182;</a>
              </div>
              <p>Abort if <code>branch</code> on <code>remote</code> cannot be fast forwarded to
the commit that <code>giverHash</code> points to.  A fast forward can
only be done if the receiver commit is an ancestor of the
giver commit.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!opts.f &amp;&amp; !merge.canFastForward(receiverHash, giverHash)) {
          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"failed to push some refs to "</span> + remotePath);</pre></div></div>
            
        </li>
        
        
        <li id="section-117">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-117">&#182;</a>
              </div>
              <p>Otherwise, do the push.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-118">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-118">&#182;</a>
              </div>
              <p>Put all the objects in the local <code>objects</code> directory into
the remote <code>objects</code> directory.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          objects.allObjects().forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(o)</span> {</span> remoteCall(objects.write, o); });</pre></div></div>
            
        </li>
        
        
        <li id="section-119">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-119">&#182;</a>
              </div>
              <p>Point <code>branch</code> on <code>remote</code> at <code>giverHash</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          remoteCall(gitlet.update_ref, refs.toLocalRef(branch), giverHash);</pre></div></div>
            
        </li>
        
        
        <li id="section-120">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-120">&#182;</a>
              </div>
              <p>Set the local repo’s record of what commit <code>branch</code> is on
at <code>remote</code> to <code>giverHash</code> (since that is what it is now
is).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          gitlet.update_ref(refs.toRemoteRef(remote, branch), giverHash);</pre></div></div>
            
        </li>
        
        
        <li id="section-121">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-121">&#182;</a>
              </div>
              <p>Report the result of the push.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">return</span> [<span class="hljs-string">"To "</span> + remotePath,
                  <span class="hljs-string">"Count "</span> + objects.allObjects().length,
                  branch + <span class="hljs-string">" -&gt; "</span> + branch].join(<span class="hljs-string">"\n"</span>) + <span class="hljs-string">"\n"</span>;
        }
      }
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-122">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-122">&#182;</a>
              </div>
              <p><strong>status()</strong> reports the state of the repo: the current branch,
untracked files, conflicted files, files that are staged to be
committed and files that are not staged to be committed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  status: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(_)</span> {</span>
    files.assertInRepo();
    config.assertNotBare();
    <span class="hljs-keyword">return</span> status.toString();
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-123">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-123">&#182;</a>
              </div>
              <p><strong>clone()</strong> copies the repository at <code>remotePath</code> to
**<code>targetPath</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  clone: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(remotePath, targetPath, opts)</span> {</span>
    opts = opts || {};</pre></div></div>
            
        </li>
        
        
        <li id="section-124">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-124">&#182;</a>
              </div>
              <p>Abort if a <code>remotePath</code> or <code>targetPath</code> not passed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (remotePath === <span class="hljs-literal">undefined</span> || targetPath === <span class="hljs-literal">undefined</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"you must specify remote path and target path"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-125">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-125">&#182;</a>
              </div>
              <p>Abort if <code>remotePath</code> does not exist, or is not a Gitlet
repository.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!fs.existsSync(remotePath) || !util.remote(remotePath)(files.inRepo)) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"repository "</span> + remotePath + <span class="hljs-string">" does not exist"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-126">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-126">&#182;</a>
              </div>
              <p>Abort if <code>targetPath</code> exists and is not empty.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fs.existsSync(targetPath) &amp;&amp; fs.readdirSync(targetPath).length &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(targetPath + <span class="hljs-string">" already exists and is not empty"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-127">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-127">&#182;</a>
              </div>
              <p>Otherwise, do the clone.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    } <span class="hljs-keyword">else</span> {

      remotePath = nodePath.resolve(process.cwd(), remotePath);</pre></div></div>
            
        </li>
        
        
        <li id="section-128">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-128">&#182;</a>
              </div>
              <p>If <code>targetPath</code> doesn’t exist, create it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (!fs.existsSync(targetPath)) {
        fs.mkdirSync(targetPath);
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-129">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-129">&#182;</a>
              </div>
              <p>In the directory for the new remote repository…</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      util.remote(targetPath)(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-130">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-130">&#182;</a>
              </div>
              <p>Initialize the directory as a Gitlet repository.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        gitlet.init(opts);</pre></div></div>
            
        </li>
        
        
        <li id="section-131">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-131">&#182;</a>
              </div>
              <p>Set up <code>remotePath</code> as a remote called “origin”.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        gitlet.remote(<span class="hljs-string">"add"</span>, <span class="hljs-string">"origin"</span>, nodePath.relative(process.cwd(), remotePath));</pre></div></div>
            
        </li>
        
        
        <li id="section-132">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-132">&#182;</a>
              </div>
              <p>Get the hash of the commit that master is pointing at on
the remote repository.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> remoteHeadHash = util.remote(remotePath)(refs.hash, <span class="hljs-string">"master"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-133">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-133">&#182;</a>
              </div>
              <p>If the remote repo has any commits, that hash will exist.
The new repository records the commit that the passed
<code>branch</code> is at on the remote.  It then sets master on the
new repository to point at that commit.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (remoteHeadHash !== <span class="hljs-literal">undefined</span>) {
          gitlet.fetch(<span class="hljs-string">"origin"</span>, <span class="hljs-string">"master"</span>);
          merge.writeFastForwardMerge(<span class="hljs-literal">undefined</span>, remoteHeadHash);
        }
      });</pre></div></div>
            
        </li>
        
        
        <li id="section-134">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-134">&#182;</a>
              </div>
              <p>Report the result of the clone.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">return</span> <span class="hljs-string">"Cloning into "</span> + targetPath;
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-135">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-135">&#182;</a>
              </div>
              <p><strong>update_index()</strong> adds the contents of the file at <code>path</code> to the
index, or removes the file from the index.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  update_index: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path, opts)</span> {</span>
    files.assertInRepo();
    config.assertNotBare();
    opts = opts || {};

    <span class="hljs-keyword">var</span> pathFromRoot = files.pathFromRepoRoot(path);
    <span class="hljs-keyword">var</span> isOnDisk = fs.existsSync(path);
    <span class="hljs-keyword">var</span> isInIndex = index.hasFile(path, <span class="hljs-number">0</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-136">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-136">&#182;</a>
              </div>
              <p>Abort if <code>path</code> is a directory.  <code>update_index()</code> only handles
single files.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (isOnDisk &amp;&amp; fs.statSync(path).isDirectory()) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(pathFromRoot + <span class="hljs-string">" is a directory - add files inside\n"</span>);

    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (opts.remove &amp;&amp; !isOnDisk &amp;&amp; isInIndex) {</pre></div></div>
            
        </li>
        
        
        <li id="section-137">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-137">&#182;</a>
              </div>
              <p>Abort if file is being removed and is in conflict.  Gitlet
doesn’t support this.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (index.isFileInConflict(path)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"unsupported"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-138">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-138">&#182;</a>
              </div>
              <p>If files is being removed, is not on disk and is in the
index, remove it from the index.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      } <span class="hljs-keyword">else</span> {
        index.writeRm(path);
        <span class="hljs-keyword">return</span> <span class="hljs-string">"\n"</span>;
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-139">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-139">&#182;</a>
              </div>
              <p>If file is being removed, is not on disk and not in the index,
there is no work to do.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (opts.remove &amp;&amp; !isOnDisk &amp;&amp; !isInIndex) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">"\n"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-140">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-140">&#182;</a>
              </div>
              <p>Abort if the file is on disk and not in the index and the
<code>--add</code> was not passed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!opts.add &amp;&amp; isOnDisk &amp;&amp; !isInIndex) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"cannot add "</span> + pathFromRoot + <span class="hljs-string">" to index - use --add option\n"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-141">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-141">&#182;</a>
              </div>
              <p>If file is on disk and either <code>-add</code> was passed or the file is
in the index, add the file’s current content to the index.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isOnDisk &amp;&amp; (opts.add || isInIndex)) {
      index.writeAdd(path);
      <span class="hljs-keyword">return</span> <span class="hljs-string">"\n"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-142">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-142">&#182;</a>
              </div>
              <p>Abort if the file is not on disk and <code>--remove</code> not passed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!opts.remove &amp;&amp; !isOnDisk) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(pathFromRoot + <span class="hljs-string">" does not exist and --remove not passed\n"</span>);
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-143">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-143">&#182;</a>
              </div>
              <p><strong>write_tree()</strong> takes the content of the index and stores a tree
object that represents that content to the <code>objects</code> directory.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  write_tree: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(_)</span> {</span>
    files.assertInRepo();
    <span class="hljs-keyword">return</span> objects.writeTree(files.nestFlatTree(index.toc()));
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-144">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-144">&#182;</a>
              </div>
              <p><strong>update_ref()</strong> gets the hash of the commit that <code>refToUpdateTo</code>
points at and sets <code>refToUpdate</code> to point at the same hash.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  update_ref: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(refToUpdate, refToUpdateTo, _)</span> {</span>
    files.assertInRepo();</pre></div></div>
            
        </li>
        
        
        <li id="section-145">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-145">&#182;</a>
              </div>
              <p>Get the hash that <code>refToUpdateTo</code> points at.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> hash = refs.hash(refToUpdateTo);</pre></div></div>
            
        </li>
        
        
        <li id="section-146">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-146">&#182;</a>
              </div>
              <p>Abort if <code>refToUpdateTo</code> does not point at a hash.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!objects.exists(hash)) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(refToUpdateTo + <span class="hljs-string">" not a valid SHA1"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-147">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-147">&#182;</a>
              </div>
              <p>Abort if <code>refToUpdate</code> does not match the syntax of a ref.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!refs.isRef(refToUpdate)) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"cannot lock the ref "</span> + refToUpdate);</pre></div></div>
            
        </li>
        
        
        <li id="section-148">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-148">&#182;</a>
              </div>
              <p>Abort if <code>hash</code> points to an object in the <code>objects</code> directory
that is not a commit.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (objects.type(objects.read(hash)) !== <span class="hljs-string">"commit"</span>) {
      <span class="hljs-keyword">var</span> branch = refs.terminalRef(refToUpdate);
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(branch + <span class="hljs-string">" cannot refer to non-commit object "</span> + hash + <span class="hljs-string">"\n"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-149">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-149">&#182;</a>
              </div>
              <p>Otherwise, set the contents of the file that the ref represents
to <code>hash</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    } <span class="hljs-keyword">else</span> {
      refs.write(refs.terminalRef(refToUpdate), hash);
    }
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-150">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-150">&#182;</a>
              </div>
              <h2 id="refs-module">Refs module</h2>

            </div>
            
        </li>
        
        
        <li id="section-151">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-151">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-152">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-152">&#182;</a>
              </div>
              <p>Refs are names for commit hashes.  The ref is the name of a file.
Some refs represent local branches, like <code>refs/heads/master</code> or
<code>refs/heads/feature</code>.  Some represent remote branches, like
<code>refs/remotes/origin/master</code>.  Some represent important states of
the repository, like <code>HEAD</code>, <code>MERGE_HEAD</code> and <code>FETCH_HEAD</code>.  Ref
files contain either a hash or another ref.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">var</span> refs = {</pre></div></div>
            
        </li>
        
        
        <li id="section-153">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-153">&#182;</a>
              </div>
              <p><strong>isRef()</strong> returns true if <code>ref</code> matches valid qualified ref
syntax.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  isRef: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(ref)</span> {</span>
    <span class="hljs-keyword">return</span> ref !== <span class="hljs-literal">undefined</span> &amp;&amp;
      (ref.match(<span class="hljs-string">"^refs/heads/[A-Za-z-]+$"</span>) ||
       ref.match(<span class="hljs-string">"^refs/remotes/[A-Za-z-]+/[A-Za-z-]+$"</span>) ||
       [<span class="hljs-string">"HEAD"</span>, <span class="hljs-string">"FETCH_HEAD"</span>, <span class="hljs-string">"MERGE_HEAD"</span>].indexOf(ref) !== -<span class="hljs-number">1</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-154">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-154">&#182;</a>
              </div>
              <p><strong>terminalRef()</strong> resolves <code>ref</code> to the most specific ref
possible.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  terminalRef: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(ref)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-155">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-155">&#182;</a>
              </div>
              <p>If <code>ref</code> is “HEAD” and head is pointing at a branch, return the
branch.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (ref === <span class="hljs-string">"HEAD"</span> &amp;&amp; !<span class="hljs-keyword">this</span>.isHeadDetached()) {
      <span class="hljs-keyword">return</span> files.read(files.gitletPath(<span class="hljs-string">"HEAD"</span>)).match(<span class="hljs-string">"ref: (refs/heads/.+)"</span>)[<span class="hljs-number">1</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-156">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-156">&#182;</a>
              </div>
              <p>If ref is qualified, return it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (refs.isRef(ref)) {
      <span class="hljs-keyword">return</span> ref;</pre></div></div>
            
        </li>
        
        
        <li id="section-157">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-157">&#182;</a>
              </div>
              <p>Otherwise, assume ref is an unqualified local ref (like
<code>master</code>) and turn it into a qualified ref (like
<code>refs/heads/master</code>)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> refs.toLocalRef(ref);
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-158">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-158">&#182;</a>
              </div>
              <p><strong>hash()</strong> returns the hash that <code>refOrHash</code> points to.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  hash: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(refOrHash)</span> {</span>
    <span class="hljs-keyword">if</span> (objects.exists(refOrHash)) {
      <span class="hljs-keyword">return</span> refOrHash;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">var</span> terminalRef = refs.terminalRef(refOrHash);
      <span class="hljs-keyword">if</span> (terminalRef === <span class="hljs-string">"FETCH_HEAD"</span>) {
        <span class="hljs-keyword">return</span> refs.fetchHeadBranchToMerge(refs.headBranchName());
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (refs.exists(terminalRef)) {
        <span class="hljs-keyword">return</span> files.read(files.gitletPath(terminalRef));
      }
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-159">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-159">&#182;</a>
              </div>
              <p><strong>isHeadDetached()</strong> returns true if <code>HEAD</code> contains a commit
hash, rather than the ref of a branch.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  isHeadDetached: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">return</span> files.read(files.gitletPath(<span class="hljs-string">"HEAD"</span>)).match(<span class="hljs-string">"refs"</span>) === <span class="hljs-literal">null</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-160">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-160">&#182;</a>
              </div>
              <p><strong>isCheckedOut()</strong> returns true if the repository is not bare and
<code>HEAD</code> is pointing at the branch called <code>branch</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  isCheckedOut: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(branch)</span> {</span>
    <span class="hljs-keyword">return</span> !config.isBare() &amp;&amp; refs.headBranchName() === branch;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-161">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-161">&#182;</a>
              </div>
              <p><strong>toLocalRef()</strong> converts the branch name <code>name</code> into a qualified
local branch ref.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  toLocalRef: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name)</span> {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"refs/heads/"</span> + name;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-162">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-162">&#182;</a>
              </div>
              <p><strong>toRemoteRef()</strong> converts <code>remote</code> and branch name <code>name</code> into a
qualified remote branch ref.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  toRemoteRef: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(remote, name)</span> {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"refs/remotes/"</span> + remote + <span class="hljs-string">"/"</span> + name;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-163">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-163">&#182;</a>
              </div>
              <p><strong>write()</strong> sets the content of the file for the qualified ref
<code>ref</code> to <code>content</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  write: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(ref, content)</span> {</span>
    <span class="hljs-keyword">if</span> (refs.isRef(ref)) {
      files.write(files.gitletPath(ref), content);
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-164">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-164">&#182;</a>
              </div>
              <p><strong>rm()</strong> removes the file for the qualified ref <code>ref</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  rm: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(ref)</span> {</span>
    <span class="hljs-keyword">if</span> (refs.isRef(ref)) {
      fs.unlinkSync(files.gitletPath(ref));
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-165">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-165">&#182;</a>
              </div>
              <p><strong>fetchHeadBranchToMerge()</strong> reads the <code>FETCH_HEAD</code> file and gets
the hash that the remote <code>branchName</code> is pointing at.  For more
information about <code>FETCH_HEAD</code> see <a href="#section-80">gitlet.fetch()</a>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  fetchHeadBranchToMerge: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(branchName)</span> {</span>
    <span class="hljs-keyword">return</span> util.lines(files.read(files.gitletPath(<span class="hljs-string">"FETCH_HEAD"</span>)))
      .filter(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(l)</span> {</span> <span class="hljs-keyword">return</span> l.match(<span class="hljs-string">"^.+ branch "</span> + branchName + <span class="hljs-string">" of"</span>); })
      .map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(l)</span> {</span> <span class="hljs-keyword">return</span> l.match(<span class="hljs-string">"^([^ ]+) "</span>)[<span class="hljs-number">1</span>]; })[<span class="hljs-number">0</span>];
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-166">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-166">&#182;</a>
              </div>
              <p><strong>localHeads()</strong> returns a JS object that maps local branch names
to the hash of the commit they point to.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  localHeads: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">return</span> fs.readdirSync(nodePath.join(files.gitletPath(), <span class="hljs-string">"refs"</span>, <span class="hljs-string">"heads"</span>))
      .reduce(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(o, n)</span> {</span> <span class="hljs-keyword">return</span> util.setIn(o, [n, refs.hash(n)]); }, {});
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-167">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-167">&#182;</a>
              </div>
              <p><strong>exists()</strong> returns true if the qualified ref <code>ref</code> exists.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  exists: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(ref)</span> {</span>
    <span class="hljs-keyword">return</span> refs.isRef(ref) &amp;&amp; fs.existsSync(files.gitletPath(ref));
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-168">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-168">&#182;</a>
              </div>
              <p><strong>headBranchName()</strong> returns the name of the branch that <code>HEAD</code>
is pointing at.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  headBranchName: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">if</span> (!refs.isHeadDetached()) {
      <span class="hljs-keyword">return</span> files.read(files.gitletPath(<span class="hljs-string">"HEAD"</span>)).match(<span class="hljs-string">"refs/heads/(.+)"</span>)[<span class="hljs-number">1</span>];
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-169">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-169">&#182;</a>
              </div>
              <p><strong>commitParentHashes()</strong> returns the array of commits that would
be the parents of the next commit.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  commitParentHashes: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> headHash = refs.hash(<span class="hljs-string">"HEAD"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-170">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-170">&#182;</a>
              </div>
              <p>If the repository is in the middle of a merge, return the
hashes of the two commits being merged.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (merge.isMergeInProgress()) {
      <span class="hljs-keyword">return</span> [headHash, refs.hash(<span class="hljs-string">"MERGE_HEAD"</span>)];</pre></div></div>
            
        </li>
        
        
        <li id="section-171">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-171">&#182;</a>
              </div>
              <p>If this repository has no commits, return an empty array.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (headHash === <span class="hljs-literal">undefined</span>) {
      <span class="hljs-keyword">return</span> [];</pre></div></div>
            
        </li>
        
        
        <li id="section-172">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-172">&#182;</a>
              </div>
              <p>Otherwise, return the hash of the commit that <code>HEAD</code> is
currently pointing at.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> [headHash];
    }
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-173">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-173">&#182;</a>
              </div>
              <h2 id="objects-module">Objects module</h2>

            </div>
            
        </li>
        
        
        <li id="section-174">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-174">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-175">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-175">&#182;</a>
              </div>
              <p>Objects are files in the <code>.gitlet/objects/</code> directory.</p>
<ul>
<li>A blob object stores the content of a file.  For example, if a
file called <code>numbers.txt</code> that contains <code>first</code> is added to the
index, a blob called <code>hash(first)</code> will be created containing
<code>&quot;first&quot;</code>.</li>
<li>A tree object stores a list of files and directories in a
directory in the repository.  Entries in the list for files point
to blob objects.  Entries in the list for directories point at
other tree objects.</li>
<li>A commit object stores a pointer to a tree object and a message.
It represents the state of the repository after a commit.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">var</span> objects = {</pre></div></div>
            
        </li>
        
        
        <li id="section-176">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-176">&#182;</a>
              </div>
              <p><strong>writeTree()</strong> stores a graph of tree objects that represent the
content currently in the index.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  writeTree: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(tree)</span> {</span>
    <span class="hljs-keyword">var</span> treeObject = <span class="hljs-built_in">Object</span>.keys(tree).map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key)</span> {</span>
      <span class="hljs-keyword">if</span> (util.isString(tree[key])) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"blob "</span> + tree[key] + <span class="hljs-string">" "</span> + key;
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"tree "</span> + objects.writeTree(tree[key]) + <span class="hljs-string">" "</span> + key;
      }
    }).join(<span class="hljs-string">"\n"</span>) + <span class="hljs-string">"\n"</span>;

    <span class="hljs-keyword">return</span> objects.write(treeObject);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-177">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-177">&#182;</a>
              </div>
              <p><strong>fileTree()</strong> takes a tree hash and finds the corresponding tree
object.  It reads the connected graph of tree objects into a
nested JS object, like:<br/>
<code>{ file1: &quot;hash(1)&quot;, src: { file2:  &quot;hash(2)&quot; }</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  fileTree: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(treeHash, tree)</span> {</span>
    <span class="hljs-keyword">if</span> (tree === <span class="hljs-literal">undefined</span>) { <span class="hljs-keyword">return</span> objects.fileTree(treeHash, {}); }

    util.lines(objects.read(treeHash)).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(line)</span> {</span>
      <span class="hljs-keyword">var</span> lineTokens = line.split(<span class="hljs-regexp">/ /</span>);
      tree[lineTokens[<span class="hljs-number">2</span>]] = lineTokens[<span class="hljs-number">0</span>] === <span class="hljs-string">"tree"</span> ?
        objects.fileTree(lineTokens[<span class="hljs-number">1</span>], {}) :
        lineTokens[<span class="hljs-number">1</span>];
    });

    <span class="hljs-keyword">return</span> tree;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-178">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-178">&#182;</a>
              </div>
              <p><strong>writeCommit()</strong> creates a commit object and writes it to the
objects database.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  writeCommit: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(treeHash, message, parentHashes)</span> {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.write(<span class="hljs-string">"commit "</span> + treeHash + <span class="hljs-string">"\n"</span> +
                      parentHashes.map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(h)</span> {</span> <span class="hljs-keyword">return</span> <span class="hljs-string">"parent "</span> + h + <span class="hljs-string">"\n"</span>; }).join(<span class="hljs-string">""</span>)+
                      <span class="hljs-string">"Date:  "</span> + <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toString() + <span class="hljs-string">"\n"</span> +
                      <span class="hljs-string">"\n"</span> +
                      <span class="hljs-string">"    "</span> + message + <span class="hljs-string">"\n"</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-179">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-179">&#182;</a>
              </div>
              <p><strong>write()</strong> writes <code>str</code> to the objects database.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  write: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str)</span> {</span>
    files.write(nodePath.join(files.gitletPath(), <span class="hljs-string">"objects"</span>, util.hash(str)), str);
    <span class="hljs-keyword">return</span> util.hash(str);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-180">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-180">&#182;</a>
              </div>
              <p><strong>isUpToDate()</strong> returns true if the giver commit has already
been incorporated into the receiver commit.  That is, it returns
true if the giver commit is an ancestor of the receiver, or they
are the same commit.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  isUpToDate: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(receiverHash, giverHash)</span> {</span>
    <span class="hljs-keyword">return</span> receiverHash !== <span class="hljs-literal">undefined</span> &amp;&amp;
      (receiverHash === giverHash || objects.isAncestor(receiverHash, giverHash));
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-181">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-181">&#182;</a>
              </div>
              <p><strong>exists()</strong> returns true if there is an object in the database
called <code>objectHash</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  exists: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(objectHash)</span> {</span>
    <span class="hljs-keyword">return</span> objectHash !== <span class="hljs-literal">undefined</span> &amp;&amp;
      fs.existsSync(nodePath.join(files.gitletPath(), <span class="hljs-string">"objects"</span>, objectHash));
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-182">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-182">&#182;</a>
              </div>
              <p><strong>read()</strong> returns the content of the object called <code>objectHash</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  read: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(objectHash)</span> {</span>
    <span class="hljs-keyword">if</span> (objectHash !== <span class="hljs-literal">undefined</span>) {
      <span class="hljs-keyword">var</span> objectPath = nodePath.join(files.gitletPath(), <span class="hljs-string">"objects"</span>, objectHash);
      <span class="hljs-keyword">if</span> (fs.existsSync(objectPath)) {
        <span class="hljs-keyword">return</span> files.read(objectPath);
      }
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-183">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-183">&#182;</a>
              </div>
              <p><strong>allObjects()</strong> returns an array of the string content of all
the objects in the database</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  allObjects: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">return</span> fs.readdirSync(files.gitletPath(<span class="hljs-string">"objects"</span>)).map(objects.read);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-184">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-184">&#182;</a>
              </div>
              <p><strong>type()</strong> parses <code>str</code> as an object and returns its type:
commit, tree or blob.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  type: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str)</span> {</span>
    <span class="hljs-keyword">return</span> { commit: <span class="hljs-string">"commit"</span>, tree: <span class="hljs-string">"tree"</span>, blob: <span class="hljs-string">"tree"</span> }[str.split(<span class="hljs-string">" "</span>)[<span class="hljs-number">0</span>]] || <span class="hljs-string">"blob"</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-185">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-185">&#182;</a>
              </div>
              <p><strong>isAncestor()</strong> returns true if <code>descendentHash</code> is a descendent
of <code>ancestorHash</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  isAncestor: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(descendentHash, ancestorHash)</span> {</span>
    <span class="hljs-keyword">return</span> objects.ancestors(descendentHash).indexOf(ancestorHash) !== -<span class="hljs-number">1</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-186">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-186">&#182;</a>
              </div>
              <p><strong>ancestors()</strong> returns an array of the hashes of all the
ancestor commits of <code>commitHash</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  ancestors: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(commitHash)</span> {</span>
    <span class="hljs-keyword">var</span> parents = objects.parentHashes(objects.read(commitHash));
    <span class="hljs-keyword">return</span> util.flatten(parents.concat(parents.map(objects.ancestors)));
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-187">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-187">&#182;</a>
              </div>
              <p><strong>parentHashes()</strong> parses <code>str</code> as a commit and returns the
hashes of its parents.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  parentHashes: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str)</span> {</span>
    <span class="hljs-keyword">if</span> (objects.type(str) === <span class="hljs-string">"commit"</span>) {
      <span class="hljs-keyword">return</span> str.split(<span class="hljs-string">"\n"</span>)
        .filter(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(line)</span> {</span> <span class="hljs-keyword">return</span> line.match(<span class="hljs-regexp">/^parent/</span>); })
        .map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(line)</span> {</span> <span class="hljs-keyword">return</span> line.split(<span class="hljs-string">" "</span>)[<span class="hljs-number">1</span>]; });
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-188">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-188">&#182;</a>
              </div>
              <p><strong>parentHashes()</strong> parses <code>str</code> as a commit and returns the tree
it points at.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  treeHash: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str)</span> {</span>
    <span class="hljs-keyword">if</span> (objects.type(str) === <span class="hljs-string">"commit"</span>) {
      <span class="hljs-keyword">return</span> str.split(<span class="hljs-regexp">/\s/</span>)[<span class="hljs-number">1</span>];
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-189">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-189">&#182;</a>
              </div>
              <p><strong>commitToc()</strong> takes the hash of a commit and reads the content
stored in the tree on the commit.  It turns that tree into a
table of content that maps filenames to hashes of the files’
content, like: <code>{ &quot;file1&quot;: hash(1), &quot;a/file2&quot;: &quot;hash(2)&quot; }</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  commitToc: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(hash)</span> {</span>
    <span class="hljs-keyword">return</span> files.flattenNestedTree(objects.fileTree(objects.treeHash(objects.read(hash))));
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-190">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-190">&#182;</a>
              </div>
              <h2 id="index-module">Index module</h2>

            </div>
            
        </li>
        
        
        <li id="section-191">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-191">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-192">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-192">&#182;</a>
              </div>
              <p>The index maps files to hashes of their content.  When a commit is
created, a tree is built that mirrors the content of the index.</p>

            </div>
            
        </li>
        
        
        <li id="section-193">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-193">&#182;</a>
              </div>
              <p>Index entry keys are actually a <code>path,stage</code> combination.  Stage is
always <code>0</code>, unless the entry is about a file that is in conflict.
See <code>merge.writeIndex()</code> for more details.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">var</span> index = {</pre></div></div>
            
        </li>
        
        
        <li id="section-194">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-194">&#182;</a>
              </div>
              <p><strong>hasFile()</strong> returns true if there is an entry for <code>path</code> in the
index <code>stage</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  hasFile: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path, stage)</span> {</span>
    <span class="hljs-keyword">return</span> index.read()[index.key(path, stage)] !== <span class="hljs-literal">undefined</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-195">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-195">&#182;</a>
              </div>
              <p><strong>read()</strong> returns the index as a JS object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  read: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> indexFilePath = files.gitletPath(<span class="hljs-string">"index"</span>);
    <span class="hljs-keyword">return</span> util.lines(fs.existsSync(indexFilePath) ? files.read(indexFilePath) : <span class="hljs-string">"\n"</span>)
      .reduce(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(idx, blobStr)</span> {</span>
        <span class="hljs-keyword">var</span> blobData = blobStr.split(<span class="hljs-regexp">/ /</span>);
        idx[index.key(blobData[<span class="hljs-number">0</span>], blobData[<span class="hljs-number">1</span>])] = blobData[<span class="hljs-number">2</span>];
        <span class="hljs-keyword">return</span> idx;
      }, {});
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-196">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-196">&#182;</a>
              </div>
              <p><strong>key()</strong> returns an index key made from <code>path</code> and <code>stage</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  key: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path, stage)</span> {</span>
    <span class="hljs-keyword">return</span> path + <span class="hljs-string">","</span> + stage;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-197">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-197">&#182;</a>
              </div>
              <p><strong>keyPieces()</strong> returns a JS object that contains the path and
stage of ‘key`.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  keyPieces: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key)</span> {</span>
    <span class="hljs-keyword">var</span> pieces = key.split(<span class="hljs-regexp">/,/</span>);
    <span class="hljs-keyword">return</span> { path: pieces[<span class="hljs-number">0</span>], stage: <span class="hljs-built_in">parseInt</span>(pieces[<span class="hljs-number">1</span>]) };
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-198">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-198">&#182;</a>
              </div>
              <p><strong>toc()</strong> returns an object that maps file paths to hashes of
their content.  This function is like <code>read()</code>, except the JS
object it returns only uses the file path as a key.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  toc: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> idx = index.read();
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.keys(idx)
      .reduce(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, k)</span> {</span> <span class="hljs-keyword">return</span> util.setIn(obj, [k.split(<span class="hljs-string">","</span>)[<span class="hljs-number">0</span>], idx[k]]); }, {});
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-199">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-199">&#182;</a>
              </div>
              <p><strong>isFileInConflict()</strong> returns true the file for <code>path</code> is in
conflict.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  isFileInConflict: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path)</span> {</span>
    <span class="hljs-keyword">return</span> index.hasFile(path, <span class="hljs-number">2</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-200">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-200">&#182;</a>
              </div>
              <p><strong>conflictedPaths()</strong> returns an array of all the paths of files
that are in conflict.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  conflictedPaths: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> idx = index.read();
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.keys(idx)
      .filter(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k)</span> {</span> <span class="hljs-keyword">return</span> index.keyPieces(k).stage === <span class="hljs-number">2</span>; })
      .map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k)</span> {</span> <span class="hljs-keyword">return</span> index.keyPieces(k).path; });
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-201">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-201">&#182;</a>
              </div>
              <p><strong>writeAdd()</strong> gets the current content of the file at <code>path</code> in
the working copy.  It stores that content in the index.  If that
file is in conflict, it is set to be no longer in conflict.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  writeAdd: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path)</span> {</span>
    <span class="hljs-keyword">if</span> (index.isFileInConflict(path)) {
      index.rmEntry(path, <span class="hljs-number">1</span>);
      index.rmEntry(path, <span class="hljs-number">2</span>);
      index.rmEntry(path, <span class="hljs-number">3</span>);
    }

    index.writeEntry(path, <span class="hljs-number">0</span>, files.read(files.workingCopyPath(path)));
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-202">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-202">&#182;</a>
              </div>
              <p><strong>writeRm()</strong> removes <code>path</code> from the index.  This operation will
do nothing if the file is in conflict.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  writeRm: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path)</span> {</span>
    index.rmEntry(path, <span class="hljs-number">0</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-203">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-203">&#182;</a>
              </div>
              <p><strong>writeEntry()</strong> adds a hash of <code>content</code> to the index at key
<code>path,stage</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  writeEntry: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path, stage, content)</span> {</span>
    <span class="hljs-keyword">var</span> idx = index.read();
    idx[index.key(path, stage)] = objects.write(content);
    index.write(idx);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-204">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-204">&#182;</a>
              </div>
              <p><strong>rmEntry()</strong> removes the entry at key <code>path,stage</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  rmEntry: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path, stage)</span> {</span>
    <span class="hljs-keyword">var</span> idx = index.read();
    <span class="hljs-keyword">delete</span> idx[index.key(path, stage)];
    index.write(idx);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-205">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-205">&#182;</a>
              </div>
              <p><strong>write()</strong> takes a JS object that represents an index and writes
it to <code>.gitlet/index</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  write: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(index)</span> {</span>
    <span class="hljs-keyword">var</span> indexStr = <span class="hljs-built_in">Object</span>.keys(index)
        .map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k)</span> {</span> <span class="hljs-keyword">return</span> k.split(<span class="hljs-string">","</span>)[<span class="hljs-number">0</span>] + <span class="hljs-string">" "</span> + k.split(<span class="hljs-string">","</span>)[<span class="hljs-number">1</span>] + <span class="hljs-string">" "</span> + index[k] })
        .join(<span class="hljs-string">"\n"</span>) + <span class="hljs-string">"\n"</span>;
    files.write(files.gitletPath(<span class="hljs-string">"index"</span>), indexStr);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-206">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-206">&#182;</a>
              </div>
              <p><strong>workingCopyToc()</strong> returns an object that maps the file paths
in the working copy to hashes of those files’ content.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  workingCopyToc: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.keys(index.read())
      .map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k)</span> {</span> <span class="hljs-keyword">return</span> k.split(<span class="hljs-string">","</span>)[<span class="hljs-number">0</span>]; })
      .filter(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(p)</span> {</span> <span class="hljs-keyword">return</span> fs.existsSync(files.workingCopyPath(p)); })
      .reduce(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(idx, p)</span> {</span>
        idx[p] = util.hash(files.read(files.workingCopyPath(p)))
        <span class="hljs-keyword">return</span> idx;
      }, {});
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-207">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-207">&#182;</a>
              </div>
              <p><strong>tocToIndex()</strong> takes an object that maps file paths to hashes
of the files’ content.  It returns an object that is identical,
except the keys of the object are composed of the file paths and
stage <code>0</code>.  eg: `{ “file1,0”: hash(1), “src/file2,0”: hash(2) }’</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  tocToIndex: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(toc)</span> {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.keys(toc)
      .reduce(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(idx, p)</span> {</span> <span class="hljs-keyword">return</span> util.setIn(idx, [index.key(p, <span class="hljs-number">0</span>), toc[p]]); }, {});
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-208">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-208">&#182;</a>
              </div>
              <p><strong>matchingFiles()</strong> returns all the paths in the index that match
<code>pathSpec</code>.  It matches relative to <code>currentDir</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  matchingFiles: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(pathSpec)</span> {</span>
    <span class="hljs-keyword">var</span> searchPath = files.pathFromRepoRoot(pathSpec);
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.keys(index.toc())
      .filter(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(p)</span> {</span> <span class="hljs-keyword">return</span> p.match(<span class="hljs-string">"^"</span> + searchPath); });
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-209">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-209">&#182;</a>
              </div>
              <h2 id="diff-module">Diff module</h2>

            </div>
            
        </li>
        
        
        <li id="section-210">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-210">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-211">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-211">&#182;</a>
              </div>
              <p>Produces diffs between versions of the repository content.  Diffs
are represented as JS objects that map file paths to objects that
indicate the change required to get from the first version of the
file (the receiver) to the second (the giver).  eg:</p>
<pre>{
  file1: {
    status: "A",
    receiver: undefined,
    base: undefined,
    giver: hash(1)
  },
  file2: {
    status: "C",
    receiver: hash(b),
    base: hash(a),
    giver: hash(c)
  }
}</pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">var</span> diff = {
  FILE_STATUS: { ADD: <span class="hljs-string">"A"</span>, MODIFY: <span class="hljs-string">"M"</span>, DELETE: <span class="hljs-string">"D"</span>, SAME: <span class="hljs-string">"SAME"</span>, CONFLICT: <span class="hljs-string">"CONFLICT"</span> },</pre></div></div>
            
        </li>
        
        
        <li id="section-212">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-212">&#182;</a>
              </div>
              <p><strong>diff()</strong> returns a diff object (see above for the format of a
diff object).  If <code>hash1</code> is passed, it is used as the first
version in the diff.  If it is not passed, the index is used.  If
<code>hash2</code> is passed, it is used as the second version in the diff.
If it is not passed` the working copy is used.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  diff: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(hash1, hash2)</span> {</span>
    <span class="hljs-keyword">var</span> a = hash1 === <span class="hljs-literal">undefined</span> ? index.toc() : objects.commitToc(hash1);
    <span class="hljs-keyword">var</span> b = hash2 === <span class="hljs-literal">undefined</span> ? index.workingCopyToc() : objects.commitToc(hash2);
    <span class="hljs-keyword">return</span> diff.tocDiff(a, b);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-213">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-213">&#182;</a>
              </div>
              <p><strong>nameStatus()</strong> takes a diff and returns a JS object that maps
from file paths to file statuses.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  nameStatus: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(dif)</span> {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.keys(dif)
      .filter(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(p)</span> {</span> <span class="hljs-keyword">return</span> dif[p].status !== diff.FILE_STATUS.SAME; })
      .reduce(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(ns, p)</span> {</span> <span class="hljs-keyword">return</span> util.setIn(ns, [p, dif[p].status]); }, {});
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-214">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-214">&#182;</a>
              </div>
              <p><strong>tocDiff()</strong> takes three JS objects that map file paths to
hashes of file content.  It returns a diff between <code>receiver</code> and
<code>giver</code> (see the module description for the format).  <code>base</code> is
the version that is the most recent commen ancestor of the
<code>receiver</code> and <code>giver</code>.  If <code>base</code> is not passed, <code>receiver</code> is
used as the base.  The base is only passed when getting the diff
for a merge.  This is the only time the conflict status might be
used.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  tocDiff: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(receiver, giver, base)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-215">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-215">&#182;</a>
              </div>
              <p>fileStatus() takes three strings that represent different
versions of the content of a file.  It returns the change that
needs to be made to get from the <code>receiver</code> to the <code>giver</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fileStatus</span><span class="hljs-params">(receiver, giver, base)</span> {</span>
      <span class="hljs-keyword">var</span> receiverPresent = receiver !== <span class="hljs-literal">undefined</span>;
      <span class="hljs-keyword">var</span> basePresent = base !== <span class="hljs-literal">undefined</span>;
      <span class="hljs-keyword">var</span> giverPresent = giver !== <span class="hljs-literal">undefined</span>;
      <span class="hljs-keyword">if</span> (receiverPresent &amp;&amp; giverPresent &amp;&amp; receiver !== giver) {
        <span class="hljs-keyword">if</span> (receiver !== base &amp;&amp; giver !== base) {
          <span class="hljs-keyword">return</span> diff.FILE_STATUS.CONFLICT;
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">return</span> diff.FILE_STATUS.MODIFY;
        }
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (receiver === giver) {
        <span class="hljs-keyword">return</span> diff.FILE_STATUS.SAME;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((!receiverPresent &amp;&amp; !basePresent &amp;&amp; giverPresent) ||
                 (receiverPresent &amp;&amp; !basePresent &amp;&amp; !giverPresent)) {
        <span class="hljs-keyword">return</span> diff.FILE_STATUS.ADD;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((receiverPresent &amp;&amp; basePresent &amp;&amp; !giverPresent) ||
                 (!receiverPresent &amp;&amp; basePresent &amp;&amp; giverPresent)) {
        <span class="hljs-keyword">return</span> diff.FILE_STATUS.DELETE;
      }
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-216">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-216">&#182;</a>
              </div>
              <p>If <code>base</code> was not passed, use <code>receiver</code> as the base.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    base = base || receiver;</pre></div></div>
            
        </li>
        
        
        <li id="section-217">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-217">&#182;</a>
              </div>
              <p>Get an array of all the paths in all the versions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> paths = <span class="hljs-built_in">Object</span>.keys(receiver).concat(<span class="hljs-built_in">Object</span>.keys(base)).concat(<span class="hljs-built_in">Object</span>.keys(giver));</pre></div></div>
            
        </li>
        
        
        <li id="section-218">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-218">&#182;</a>
              </div>
              <p>Create and return diff.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> util.unique(paths).reduce(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(idx, p)</span> {</span>
      <span class="hljs-keyword">return</span> util.setIn(idx, [p, {
        status: fileStatus(receiver[p], giver[p], base[p]),
        receiver: receiver[p],
        base: base[p],
        giver: giver[p]
      }]);
    }, {});
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-219">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-219">&#182;</a>
              </div>
              <p><strong>changedFilesCommitWouldOverwrite()</strong> gets a list of files
changed in the working copy.  It gets a list of the files that
are different in the head commit and the commit for the passed
hash.  It returns a list of paths that appear in both lists.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  changedFilesCommitWouldOverwrite: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(hash)</span> {</span>
    <span class="hljs-keyword">var</span> headHash = refs.hash(<span class="hljs-string">"HEAD"</span>);
    <span class="hljs-keyword">var</span> hashToWcDiff = diff.nameStatus(diff.diff(headHash));
    <span class="hljs-keyword">var</span> headToHashDiff = diff.nameStatus(diff.diff(headHash, hash));
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.keys(hashToWcDiff).filter(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(p)</span> {</span> <span class="hljs-keyword">return</span> p <span class="hljs-keyword">in</span> headToHashDiff; });
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-220">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-220">&#182;</a>
              </div>
              <p><strong>addedOrModifiedFiles()</strong> returns a list of files that have been
added to or modified in the working copy since the last commit.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  addedOrModifiedFiles: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> headToc = refs.hash(<span class="hljs-string">"HEAD"</span>) ? objects.commitToc(refs.hash(<span class="hljs-string">"HEAD"</span>)) : {};
    <span class="hljs-keyword">var</span> wc = diff.nameStatus(diff.tocDiff(headToc, index.workingCopyToc()));
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.keys(wc).filter(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(p)</span> {</span> <span class="hljs-keyword">return</span> wc[p] !== diff.FILE_STATUS.DELETE; });
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-221">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-221">&#182;</a>
              </div>
              <h2 id="merge-module">Merge module</h2>

            </div>
            
        </li>
        
        
        <li id="section-222">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-222">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">var</span> merge = {</pre></div></div>
            
        </li>
        
        
        <li id="section-223">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-223">&#182;</a>
              </div>
              <p><strong>commonAncestor()</strong> returns the hash of the commit that is the
most recent common ancestor of <code>aHash</code> and <code>bHash</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  commonAncestor: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(aHash, bHash)</span> {</span>
    <span class="hljs-keyword">var</span> sorted = [aHash, bHash].sort();
    aHash = sorted[<span class="hljs-number">0</span>];
    bHash = sorted[<span class="hljs-number">1</span>];
    <span class="hljs-keyword">var</span> aAncestors = [aHash].concat(objects.ancestors(aHash));
    <span class="hljs-keyword">var</span> bAncestors = [bHash].concat(objects.ancestors(bHash));
    <span class="hljs-keyword">return</span> util.intersection(aAncestors, bAncestors)[<span class="hljs-number">0</span>];
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-224">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-224">&#182;</a>
              </div>
              <p><strong>isMergeInProgress()</strong> returns true if the repository is in the
middle of a merge.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  isMergeInProgress: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">return</span> refs.hash(<span class="hljs-string">"MERGE_HEAD"</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-225">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-225">&#182;</a>
              </div>
              <p><strong>canFastForward()</strong> A fast forward is possible if the changes
made to get to the <code>giverHash</code> commit already incorporate the
changes made to get to the <code>receiverHash</code> commit.  So,
<code>canFastForward()</code> returns true if the <code>receiverHash</code> commit is
an ancestor of the <code>giverHash</code> commit.  It also returns true if
there is no <code>receiverHash</code> commit because this indicates the
repository has no commits, yet.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  canFastForward: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(receiverHash, giverHash)</span> {</span>
    <span class="hljs-keyword">return</span> receiverHash === <span class="hljs-literal">undefined</span> || objects.isAncestor(giverHash, receiverHash);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-226">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-226">&#182;</a>
              </div>
              <p><strong>isAForceFetch()</strong> returns true if hash for local commit
(<code>receiverHash</code>) is not ancestor of hash for fetched commit
(<code>giverHash</code>).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  isAForceFetch: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(receiverHash, giverHash)</span> {</span>
    <span class="hljs-keyword">return</span> receiverHash !== <span class="hljs-literal">undefined</span> &amp;&amp; !objects.isAncestor(giverHash, receiverHash);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-227">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-227">&#182;</a>
              </div>
              <p><strong>hasConflicts()</strong> returns true if merging the commit for
<code>giverHash</code> into the commit for <code>receiverHash</code> would produce
conflicts.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  hasConflicts: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(receiverHash, giverHash)</span> {</span>
    <span class="hljs-keyword">var</span> mergeDiff = merge.mergeDiff(receiverHash, giverHash);
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.keys(mergeDiff)
      .filter(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(p)</span>{</span><span class="hljs-keyword">return</span> mergeDiff[p].status===diff.FILE_STATUS.CONFLICT }).length &gt; <span class="hljs-number">0</span>
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-228">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-228">&#182;</a>
              </div>
              <p><strong>mergeDiff()</strong> returns a diff that represents the changes to get
from the <code>receiverHash</code> commit to the <code>giverHash</code> commit.
Because this is a merge diff, the function uses the common
ancestor of the <code>receiverHash</code> commit and <code>giverHash</code> commit to
avoid trivial conflicts.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  mergeDiff: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(receiverHash, giverHash)</span> {</span>
    <span class="hljs-keyword">return</span> diff.tocDiff(objects.commitToc(receiverHash),
                        objects.commitToc(giverHash),
                        objects.commitToc(merge.commonAncestor(receiverHash, giverHash)));
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-229">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-229">&#182;</a>
              </div>
              <p><strong>writeMergeMsg()</strong> creates a message for the merge commit that
will potentially be created when the <code>giverHash</code> commit is merged
into the <code>receiverHash</code> commit.  It writes this message to
<code>.gitlet/MERGE_MSG</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  writeMergeMsg: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(receiverHash, giverHash, ref)</span> {</span>
    <span class="hljs-keyword">var</span> msg = <span class="hljs-string">"Merge "</span> + ref + <span class="hljs-string">" into "</span> + refs.headBranchName();

    <span class="hljs-keyword">var</span> mergeDiff = merge.mergeDiff(receiverHash, giverHash);
    <span class="hljs-keyword">var</span> conflicts = <span class="hljs-built_in">Object</span>.keys(mergeDiff)
        .filter(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(p)</span> {</span> <span class="hljs-keyword">return</span> mergeDiff[p].status === diff.FILE_STATUS.CONFLICT });
    <span class="hljs-keyword">if</span> (conflicts.length &gt; <span class="hljs-number">0</span>) {
      msg += <span class="hljs-string">"\nConflicts:\n"</span> + conflicts.join(<span class="hljs-string">"\n"</span>);
    }

    files.write(files.gitletPath(<span class="hljs-string">"MERGE_MSG"</span>), msg);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-230">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-230">&#182;</a>
              </div>
              <p><strong>writeIndex()</strong> merges the <code>giverHash</code> commit into the
<code>receiverHash</code> commit and writes the merged content to the index.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  writeIndex: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(receiverHash, giverHash)</span> {</span>
    <span class="hljs-keyword">var</span> mergeDiff = merge.mergeDiff(receiverHash, giverHash);
    index.write({});
    <span class="hljs-built_in">Object</span>.keys(mergeDiff).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(p)</span> {</span>
      <span class="hljs-keyword">if</span> (mergeDiff[p].status === diff.FILE_STATUS.CONFLICT) {
        <span class="hljs-keyword">if</span> (mergeDiff[p].base !== <span class="hljs-literal">undefined</span>) { <span class="hljs-comment">// (undef if same filepath ADDED w dif content)</span>
          index.writeEntry(p, <span class="hljs-number">1</span>, objects.read(mergeDiff[p].base));
        }

        index.writeEntry(p, <span class="hljs-number">2</span>, objects.read(mergeDiff[p].receiver));
        index.writeEntry(p, <span class="hljs-number">3</span>, objects.read(mergeDiff[p].giver));
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mergeDiff[p].status === diff.FILE_STATUS.MODIFY) {
        index.writeEntry(p, <span class="hljs-number">0</span>, mergeDiff[p].giver);
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mergeDiff[p].status === diff.FILE_STATUS.ADD ||
                 mergeDiff[p].status === diff.FILE_STATUS.SAME) {
        <span class="hljs-keyword">var</span> content = objects.read(mergeDiff[p].receiver || mergeDiff[p].giver);
        index.writeEntry(p, <span class="hljs-number">0</span>, content);
      }
    });
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-231">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-231">&#182;</a>
              </div>
              <p><strong>writeFastForwardMerge()</strong> Fast forwarding means making the
current branch reflect the commit that <code>giverHash</code> points at.  No
new commit is created.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  writeFastForwardMerge: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(receiverHash, giverHash)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-232">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-232">&#182;</a>
              </div>
              <p>Point head at <code>giverHash</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    refs.write(refs.toLocalRef(refs.headBranchName()), giverHash);</pre></div></div>
            
        </li>
        
        
        <li id="section-233">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-233">&#182;</a>
              </div>
              <p>Make the index mirror the content of <code>giverHash</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    index.write(index.tocToIndex(objects.commitToc(giverHash)));</pre></div></div>
            
        </li>
        
        
        <li id="section-234">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-234">&#182;</a>
              </div>
              <p>If the repo is bare, it has no working copy, so there is no
more work to do.  If the repo is not bare…</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!config.isBare()) {</pre></div></div>
            
        </li>
        
        
        <li id="section-235">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-235">&#182;</a>
              </div>
              <p>…Get an object that maps from file paths in the
<code>receiverHash</code> commit to hashes of the files’ content.  If
<code>recevierHash</code> is undefined, the repository has no commits,
yet, and the mapping object is empty.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> receiverToc = receiverHash === <span class="hljs-literal">undefined</span> ? {} : objects.commitToc(receiverHash);</pre></div></div>
            
        </li>
        
        
        <li id="section-236">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-236">&#182;</a>
              </div>
              <p>…and write the content of the files to the working copy.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      workingCopy.write(diff.tocDiff(receiverToc, objects.commitToc(giverHash)));
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-237">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-237">&#182;</a>
              </div>
              <p><strong>writeNonFastForwardMerge()</strong> A non fast forward merge creates a
merge commit to integrate the content of the <code>receiverHash</code>
commit with the content of the <code>giverHash</code> commit.  This
integration requires a merge commit because, unlike a fast
forward merge, no commit yet exists that embodies the combination
of these two commits.  <code>writeNonFastForwardMerge()</code> does not
actually create the merge commit.  It just sets the wheels in
motion.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  writeNonFastForwardMerge: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(receiverHash, giverHash, giverRef)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-238">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-238">&#182;</a>
              </div>
              <p>Write <code>giverHash</code> to <code>.gitlet/MERGE_HEAD</code>.  This file acts as a
record of <code>giverHash</code> and as the signal that the repository is
in the merging state.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    refs.write(<span class="hljs-string">"MERGE_HEAD"</span>, giverHash);</pre></div></div>
            
        </li>
        
        
        <li id="section-239">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-239">&#182;</a>
              </div>
              <p>Write a standard merge commit message that will be used when
the merge commit is created.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    merge.writeMergeMsg(receiverHash, giverHash, giverRef);</pre></div></div>
            
        </li>
        
        
        <li id="section-240">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-240">&#182;</a>
              </div>
              <p>Merge the <code>receiverHash</code> commit with the <code>giverHash</code> commit and
write the content to the index.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    merge.writeIndex(receiverHash, giverHash);</pre></div></div>
            
        </li>
        
        
        <li id="section-241">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-241">&#182;</a>
              </div>
              <p>If the repo is bare, it has no working copy, so there is no
more work to do.  If the repo is not bare…</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!config.isBare()) {</pre></div></div>
            
        </li>
        
        
        <li id="section-242">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-242">&#182;</a>
              </div>
              <p>…merge the <code>receiverHash</code> commit with the <code>giverHash</code>
commit and write the content to the working copy.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      workingCopy.write(merge.mergeDiff(receiverHash, giverHash));
    }
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-243">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-243">&#182;</a>
              </div>
              <h2 id="working-copy-module">Working copy module</h2>

            </div>
            
        </li>
        
        
        <li id="section-244">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-244">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-245">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-245">&#182;</a>
              </div>
              <p>The working copy is the set of files that are inside the
repository, excluding the <code>.gitlet</code> directory.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">var</span> workingCopy = {</pre></div></div>
            
        </li>
        
        
        <li id="section-246">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-246">&#182;</a>
              </div>
              <p><strong>write()</strong> takes a diff object (see the diff module for a
description of the format) and applies the changes in it to the
working copy.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  write: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(dif)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-247">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-247">&#182;</a>
              </div>
              <p><code>composeConflict()</code> takes the hashes of two versions of the
same file and returns a string that represents the two versions
as a conflicted file:</p>
<p><pre>&lt;&lt;&lt;&lt;&lt;
version1
<code>======
version2</code>&gt;&gt;&gt;&gt;&gt;</pre>
Note that Gitlet, unlike real Git, does not do a line by line
diff and mark only the conflicted parts of the file.  If a file
is in conflict, the whole body of the file is marked as one big
conflict.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">composeConflict</span><span class="hljs-params">(receiverFileHash, giverFileHash)</span> {</span>
      <span class="hljs-keyword">return</span> <span class="hljs-string">"&lt;&lt;&lt;&lt;&lt;&lt;\n"</span> + objects.read(receiverFileHash) +
        <span class="hljs-string">"\n======\n"</span> + objects.read(giverFileHash) +
        <span class="hljs-string">"\n&gt;&gt;&gt;&gt;&gt;&gt;\n"</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-248">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-248">&#182;</a>
              </div>
              <p>Go through all the files that have changed, updating the
working copy for each.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-built_in">Object</span>.keys(dif).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(p)</span> {</span>
      <span class="hljs-keyword">if</span> (dif[p].status === diff.FILE_STATUS.ADD) {
        files.write(files.workingCopyPath(p), objects.read(dif[p].receiver || dif[p].giver));
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (dif[p].status === diff.FILE_STATUS.CONFLICT) {
        files.write(files.workingCopyPath(p), composeConflict(dif[p].receiver, dif[p].giver));
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (dif[p].status === diff.FILE_STATUS.MODIFY) {
        files.write(files.workingCopyPath(p), objects.read(dif[p].giver));
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (dif[p].status === diff.FILE_STATUS.DELETE) {
        fs.unlinkSync(files.workingCopyPath(p));
      }
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-249">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-249">&#182;</a>
              </div>
              <p>Remove any directories that have been left empty after the
deletion of all the files in them.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    fs.readdirSync(files.workingCopyPath())
      .filter(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(n)</span> {</span> <span class="hljs-keyword">return</span> n !== <span class="hljs-string">".gitlet"</span>; })
      .forEach(files.rmEmptyDirs);
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-250">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-250">&#182;</a>
              </div>
              <h2 id="config-module">Config module</h2>

            </div>
            
        </li>
        
        
        <li id="section-251">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-251">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-252">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-252">&#182;</a>
              </div>
              <p>This code allows the config file at <code>.gitlet/config</code> to be read and
written.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">var</span> config = {</pre></div></div>
            
        </li>
        
        
        <li id="section-253">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-253">&#182;</a>
              </div>
              <p><strong>isBare()</strong> returns true if the repository is bare.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  isBare: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">return</span> config.read().core[<span class="hljs-string">""</span>].bare === <span class="hljs-string">"true"</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-254">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-254">&#182;</a>
              </div>
              <p><strong>assertNotBare()</strong> throws if the repository is bare.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  assertNotBare: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">if</span> (config.isBare()) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"this operation must be run in a work tree"</span>);
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-255">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-255">&#182;</a>
              </div>
              <p><strong>read()</strong> returns the contents of the config file as a nested JS
object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  read: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">return</span> config.strToObj(files.read(files.gitletPath(<span class="hljs-string">"config"</span>)));
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-256">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-256">&#182;</a>
              </div>
              <p><strong>write()</strong> stringifies the nested JS object <code>configObj</code> and
overwrites the config file with it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  write: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(configObj)</span> {</span>
    files.write(files.gitletPath(<span class="hljs-string">"config"</span>), config.objToStr(configObj));
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-257">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-257">&#182;</a>
              </div>
              <p><strong>strToObj()</strong> parses the config string <code>str</code> and returns its
contents as a nested JS object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  strToObj: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str)</span> {</span>
    <span class="hljs-keyword">return</span> str.split(<span class="hljs-string">"["</span>)
      .map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(item)</span> {</span> <span class="hljs-keyword">return</span> item.trim(); })
      .filter(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(item)</span> {</span> <span class="hljs-keyword">return</span> item !== <span class="hljs-string">""</span>; })
      .reduce(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(c, item)</span> {</span>
        <span class="hljs-keyword">var</span> lines = item.split(<span class="hljs-string">"\n"</span>);
        <span class="hljs-keyword">var</span> entry = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-258">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-258">&#182;</a>
              </div>
              <p>section eg “core”</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        entry.push(lines[<span class="hljs-number">0</span>].match(<span class="hljs-regexp">/([^ \]]+)( |\])/</span>)[<span class="hljs-number">1</span>]);</pre></div></div>
            
        </li>
        
        
        <li id="section-259">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-259">&#182;</a>
              </div>
              <p>eg “master”</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> subsectionMatch = lines[<span class="hljs-number">0</span>].match(<span class="hljs-regexp">/\"(.+)\"/</span>);
        <span class="hljs-keyword">var</span> subsection = subsectionMatch === <span class="hljs-literal">null</span> ? <span class="hljs-string">""</span> : subsectionMatch[<span class="hljs-number">1</span>];
        entry.push(subsection);</pre></div></div>
            
        </li>
        
        
        <li id="section-260">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-260">&#182;</a>
              </div>
              <p>options and their values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        entry.push(lines.slice(<span class="hljs-number">1</span>).reduce(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(s, l)</span> {</span>
          s[l.split(<span class="hljs-string">"="</span>)[<span class="hljs-number">0</span>].trim()] = l.split(<span class="hljs-string">"="</span>)[<span class="hljs-number">1</span>].trim();
          <span class="hljs-keyword">return</span> s;
        }, {}));

        <span class="hljs-keyword">return</span> util.setIn(c, entry);
      }, { <span class="hljs-string">"remote"</span>: {} });
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-261">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-261">&#182;</a>
              </div>
              <p><strong>objToStr()</strong> <code>configObj</code> is a JS object that holds the config
for the repository.  <code>objToStr()</code> stringifies the object and
returns the string.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  objToStr: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(configObj)</span> {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.keys(configObj)
      .reduce(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(arr, section)</span> {</span>
        <span class="hljs-keyword">return</span> arr.concat(
          <span class="hljs-built_in">Object</span>.keys(configObj[section])
            .map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(subsection)</span> {</span> <span class="hljs-keyword">return</span> { section: section, subsection: subsection }})
        );
      }, [])
      .map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(entry)</span> {</span>
        <span class="hljs-keyword">var</span> subsection = entry.subsection === <span class="hljs-string">""</span> ? <span class="hljs-string">""</span> : <span class="hljs-string">" \""</span> + entry.subsection +<span class="hljs-string">"\""</span>;
        <span class="hljs-keyword">var</span> settings = configObj[entry.section][entry.subsection];
        <span class="hljs-keyword">return</span> <span class="hljs-string">"["</span> + entry.section + subsection + <span class="hljs-string">"]\n"</span> +
          <span class="hljs-built_in">Object</span>.keys(settings)
          .map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k)</span> {</span> <span class="hljs-keyword">return</span> <span class="hljs-string">"  "</span> + k + <span class="hljs-string">" = "</span> + settings[k]; })
          .join(<span class="hljs-string">"\n"</span>) + <span class="hljs-string">"\n"</span>;
      })
      .join(<span class="hljs-string">""</span>);
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-262">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-262">&#182;</a>
              </div>
              <h2 id="util-module">Util module</h2>

            </div>
            
        </li>
        
        
        <li id="section-263">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-263">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-264">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-264">&#182;</a>
              </div>
              <p>A set of handy functions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">var</span> util = {</pre></div></div>
            
        </li>
        
        
        <li id="section-265">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-265">&#182;</a>
              </div>
              <p><strong>isString()</strong> returns true if <code>thing</code> is a string.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  isString: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(thing)</span> {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> thing === <span class="hljs-string">"string"</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-266">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-266">&#182;</a>
              </div>
              <p><strong>hash()</strong> returns a hash of <code>string</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  hash: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(string)</span> {</span>
    <span class="hljs-keyword">var</span> hashInt = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; string.length; i++) {
      hashInt = hashInt * <span class="hljs-number">31</span> + string.charCodeAt(i);
      hashInt = hashInt | <span class="hljs-number">0</span>;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Math</span>.abs(hashInt).toString(<span class="hljs-number">16</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-267">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-267">&#182;</a>
              </div>
              <p><strong>setIn()</strong> takes an array that contains 1 or more keys and has
one value at the end.  It drills down into <code>obj</code> using the keys
and sets the value as the value of the last key.  eg<br/>
<code>setIn({}, [&quot;a&quot;, &quot;b&quot;, &quot;me&quot;]); // =&gt; { a: { b: &quot;me&quot; } }</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  setIn: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, arr)</span> {</span>
    <span class="hljs-keyword">if</span> (arr.length === <span class="hljs-number">2</span>) {
      obj[arr[<span class="hljs-number">0</span>]] = arr[<span class="hljs-number">1</span>];
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (arr.length &gt; <span class="hljs-number">2</span>) {
      obj[arr[<span class="hljs-number">0</span>]] = obj[arr[<span class="hljs-number">0</span>]] || {};
      util.setIn(obj[arr[<span class="hljs-number">0</span>]], arr.slice(<span class="hljs-number">1</span>));
    }

    <span class="hljs-keyword">return</span> obj;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-268">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-268">&#182;</a>
              </div>
              <p><strong>lines()</strong> takes a string, splits on newlines and returns an
array of the lines that are not empty.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  lines: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(str)</span> {</span>
    <span class="hljs-keyword">return</span> str.split(<span class="hljs-string">"\n"</span>).filter(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(l)</span> {</span> <span class="hljs-keyword">return</span> l !== <span class="hljs-string">""</span>; });
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-269">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-269">&#182;</a>
              </div>
              <p><strong>flatten()</strong> returns a flattened version of <code>arr</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  flatten: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(arr)</span> {</span>
    <span class="hljs-keyword">return</span> arr.reduce(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a, e)</span> {</span>
      <span class="hljs-keyword">return</span> a.concat(e <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Array</span> ? util.flatten(e) : e);
    }, []);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-270">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-270">&#182;</a>
              </div>
              <p><strong>unique()</strong> returns the unique elements in <code>arr</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  unique: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(arr)</span> {</span>
    <span class="hljs-keyword">return</span> arr.reduce(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a, p)</span> {</span> <span class="hljs-keyword">return</span> a.indexOf(p) === -<span class="hljs-number">1</span> ? a.concat(p) : a; }, []);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-271">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-271">&#182;</a>
              </div>
              <p><strong>intersection()</strong> takes two arrays <code>a</code> and <code>b</code>.  It returns an
array of the items that appear in both.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  intersection: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a, b)</span> {</span>
    <span class="hljs-keyword">return</span> a.filter(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> {</span> <span class="hljs-keyword">return</span> b.indexOf(e) !== -<span class="hljs-number">1</span>; });
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-272">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-272">&#182;</a>
              </div>
              <p><strong>remote()</strong> allows execution of a command on a remote
repository.  It returns an anonymous function that takes another
function <code>fn</code>.  When the anonymous function is run, it switches
to <code>remotePath</code>, executes <code>fn</code>, then switches back to the
original directory.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  remote: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(remotePath)</span> {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(fn)</span> {</span>
      <span class="hljs-keyword">var</span> originalDir = process.cwd();
      process.chdir(remotePath);
      <span class="hljs-keyword">var</span> result = fn.apply(<span class="hljs-literal">null</span>, <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>));
      process.chdir(originalDir);
      <span class="hljs-keyword">return</span> result;
    };
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-273">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-273">&#182;</a>
              </div>
              <h2 id="files-module">Files module</h2>

            </div>
            
        </li>
        
        
        <li id="section-274">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-274">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">var</span> files = {</pre></div></div>
            
        </li>
        
        
        <li id="section-275">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-275">&#182;</a>
              </div>
              <p><strong>inRepo()</strong> returns true if the current working directory is
inside a repository.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  inRepo: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">return</span> files.gitletPath() !== <span class="hljs-literal">undefined</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-276">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-276">&#182;</a>
              </div>
              <p><strong>assertInRepo()</strong> throws if the current working directory is not
inside a repository.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  assertInRepo: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">if</span> (!files.inRepo()) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"not a Gitlet repository"</span>);
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-277">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-277">&#182;</a>
              </div>
              <p><strong>pathFromRepoRoot()</strong> returns <code>path</code> relative to the repo root</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  pathFromRepoRoot: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path)</span> {</span>
    <span class="hljs-keyword">return</span> nodePath.relative(files.workingCopyPath(), nodePath.join(process.cwd(), path));
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-278">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-278">&#182;</a>
              </div>
              <p><strong>write()</strong> writes <code>content</code> to file at <code>path</code>, overwriting
anything that is already there.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  write: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path, content)</span> {</span>
    files.writeFilesFromTree(util.setIn({}, path.split(nodePath.sep).concat(content)), <span class="hljs-string">"/"</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-279">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-279">&#182;</a>
              </div>
              <p><strong>writeFilesFromTree()</strong> takes <code>tree</code> of files as a nested JS obj
and writes all those files to disk taking <code>prefix</code> as the root of
the tree.  <code>tree</code> format is: <code>{ a: { b: { c: &quot;filecontent&quot; }}}</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  writeFilesFromTree: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(tree, prefix)</span> {</span>
    <span class="hljs-built_in">Object</span>.keys(tree).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name)</span> {</span>
      <span class="hljs-keyword">var</span> path = nodePath.join(prefix, name);
      <span class="hljs-keyword">if</span> (util.isString(tree[name])) {
        fs.writeFileSync(path, tree[name]);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">if</span> (!fs.existsSync(path)) {
          fs.mkdirSync(path, <span class="hljs-string">"777"</span>);
        }

        files.writeFilesFromTree(tree[name], path);
      }
    });
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-280">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-280">&#182;</a>
              </div>
              <p><strong>rmEmptyDirs()</strong> recursively removes all the empty directories
inside <code>path</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  rmEmptyDirs: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path)</span> {</span>
    <span class="hljs-keyword">if</span> (fs.statSync(path).isDirectory()) {
      fs.readdirSync(path).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(c)</span> {</span> files.rmEmptyDirs(nodePath.join(path, c)); });
      <span class="hljs-keyword">if</span> (fs.readdirSync(path).length === <span class="hljs-number">0</span>) {
        fs.rmdirSync(path);
      }
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-281">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-281">&#182;</a>
              </div>
              <p><strong>read()</strong> returns the contents of the file at <code>path</code> as a
string.  It returns <code>undefined</code> if the file doesn’t exist.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  read: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path)</span> {</span>
    <span class="hljs-keyword">if</span> (fs.existsSync(path)) {
      <span class="hljs-keyword">return</span> fs.readFileSync(path, <span class="hljs-string">"utf8"</span>);
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-282">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-282">&#182;</a>
              </div>
              <p><strong>gitletPath()</strong> returns a string made by concatenating <code>path</code> to
the absolute path of the <code>.gitlet</code> directory of the repository.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  gitletPath: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path)</span> {</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">gitletDir</span><span class="hljs-params">(dir)</span> {</span>
      <span class="hljs-keyword">if</span> (fs.existsSync(dir)) {
        <span class="hljs-keyword">var</span> potentialConfigFile = nodePath.join(dir, <span class="hljs-string">"config"</span>);
        <span class="hljs-keyword">var</span> potentialGitletPath = nodePath.join(dir, <span class="hljs-string">".gitlet"</span>);
        <span class="hljs-keyword">if</span> (fs.existsSync(potentialConfigFile) &amp;&amp;
            files.read(potentialConfigFile).match(<span class="hljs-regexp">/\[core\]/</span>)) {
          <span class="hljs-keyword">return</span> dir;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fs.existsSync(potentialGitletPath)) {
          <span class="hljs-keyword">return</span> potentialGitletPath;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (dir !== <span class="hljs-string">"/"</span>) {
          <span class="hljs-keyword">return</span> gitletDir(nodePath.join(dir, <span class="hljs-string">".."</span>));
        }
      }
    };

    <span class="hljs-keyword">var</span> gDir = gitletDir(process.cwd());
    <span class="hljs-keyword">if</span> (gDir !== <span class="hljs-literal">undefined</span>) {
      <span class="hljs-keyword">return</span> nodePath.join(gDir, path || <span class="hljs-string">""</span>);
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-283">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-283">&#182;</a>
              </div>
              <p><strong>workingCopyPath()</strong> returns a string made by concatenating <code>path</code> to
the absolute path of the root of the repository.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  workingCopyPath: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path)</span> {</span>
    <span class="hljs-keyword">return</span> nodePath.join(nodePath.join(files.gitletPath(), <span class="hljs-string">".."</span>), path || <span class="hljs-string">""</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-284">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-284">&#182;</a>
              </div>
              <p><strong>lsRecursive()</strong> returns an array of all the files found in a
recursive search of <code>path</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  lsRecursive: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path)</span> {</span>
    <span class="hljs-keyword">if</span> (!fs.existsSync(path)) {
      <span class="hljs-keyword">return</span> [];
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fs.statSync(path).isFile()) {
      <span class="hljs-keyword">return</span> [path];
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fs.statSync(path).isDirectory()) {
      <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
      <span class="hljs-keyword">return</span> fs.readdirSync(path).reduce(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(fileList, dirChild)</span> {</span>
        <span class="hljs-keyword">return</span> fileList.concat(files.lsRecursive(nodePath.join(path, dirChild)));
      }, []);
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-285">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-285">&#182;</a>
              </div>
              <p><strong>nestFlatTree()</strong> takes <code>obj</code>, a mapping of file path strings to
content, and returns a nested JS obj where each key represents a
sub directory.  This is the opposite of
<code>flattenNestedTree()</code><br/>
eg <code>nestFlatTree({ &quot;a/b&quot;: &quot;me&quot; }); // =&gt; { a: { b: &quot;me&quot; }}</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  nestFlatTree: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.keys(obj).reduce(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(tree, wholePath)</span> {</span>
      <span class="hljs-keyword">return</span> util.setIn(tree, wholePath.split(nodePath.sep).concat(obj[wholePath]));
    }, {});
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-286">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-286">&#182;</a>
              </div>
              <p><strong>flattenNestedTree()</strong> takes <code>tree</code>, a nested JS object where
each key represents a sub directory and returns a JS object
mapping file path strings to content.  This is the opposite of
<code>nestFlatTree()</code><br/>
eg <code>flattenNestedTree({ a: { b: &quot;me&quot; }}); // =&gt; { &quot;a/b&quot;: &quot;me&quot;}</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  flattenNestedTree: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(tree, obj, prefix)</span> {</span>
    <span class="hljs-keyword">if</span> (obj === <span class="hljs-literal">undefined</span>) { <span class="hljs-keyword">return</span> files.flattenNestedTree(tree, {}, <span class="hljs-string">""</span>); }

    <span class="hljs-built_in">Object</span>.keys(tree).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(dir)</span> {</span>
      <span class="hljs-keyword">var</span> path = nodePath.join(prefix, dir);
      <span class="hljs-keyword">if</span> (util.isString(tree[dir])) {
        obj[path] = tree[dir];
      } <span class="hljs-keyword">else</span> {
        files.flattenNestedTree(tree[dir], obj, path);
      }
    });

    <span class="hljs-keyword">return</span> obj;
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-287">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-287">&#182;</a>
              </div>
              <h2 id="status-module">Status module</h2>

            </div>
            
        </li>
        
        
        <li id="section-288">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-288">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-289">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-289">&#182;</a>
              </div>
              <p>Outputs the repository status as a human-readable string.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">var</span> status = {</pre></div></div>
            
        </li>
        
        
        <li id="section-290">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-290">&#182;</a>
              </div>
              <p><strong>toString()</strong> returns the repository status as a human-readable
string.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  toString: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-291">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-291">&#182;</a>
              </div>
              <p><strong>untracked()</strong> returns an array of lines listing the files not
being tracked by Gitlet.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">untracked</span><span class="hljs-params">()</span> {</span>
      <span class="hljs-keyword">return</span> fs.readdirSync(files.workingCopyPath())
          .filter(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(p)</span> {</span> <span class="hljs-keyword">return</span> index.toc()[p] === <span class="hljs-literal">undefined</span> &amp;&amp; p !== <span class="hljs-string">".gitlet"</span>; });
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-292">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-292">&#182;</a>
              </div>
              <p><strong>toBeCommitted()</strong> returns an array of lines listing the files
that have changes that will be included in the next commit.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">toBeCommitted</span><span class="hljs-params">()</span> {</span>
      <span class="hljs-keyword">var</span> headHash = refs.hash(<span class="hljs-string">"HEAD"</span>);
      <span class="hljs-keyword">var</span> headToc = headHash === <span class="hljs-literal">undefined</span> ? {} : objects.commitToc(headHash);
      <span class="hljs-keyword">var</span> ns = diff.nameStatus(diff.tocDiff(headToc, index.toc()));
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.keys(ns).map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(p)</span> {</span> <span class="hljs-keyword">return</span> ns[p] + <span class="hljs-string">" "</span> + p; });
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-293">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-293">&#182;</a>
              </div>
              <p><strong>notStagedForCommit()</strong> returns an array of lines listing the
files that have changes that will not be included in the next
commit.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">notStagedForCommit</span><span class="hljs-params">()</span> {</span>
      <span class="hljs-keyword">var</span> ns = diff.nameStatus(diff.diff());
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.keys(ns).map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(p)</span> {</span> <span class="hljs-keyword">return</span> ns[p] + <span class="hljs-string">" "</span> + p; });
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-294">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-294">&#182;</a>
              </div>
              <p><strong>listing()</strong> keeps <code>lines</code> (prefixed by <code>heading</code>) only if it’s nonempty.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">listing</span><span class="hljs-params">(heading, lines)</span> {</span>
      <span class="hljs-keyword">return</span> lines.length &gt; <span class="hljs-number">0</span> ? [heading, lines] : [];
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-295">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-295">&#182;</a>
              </div>
              <p>Gather all the sections, keeping only nonempty ones, and flatten them
together into a string.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> util.flatten([<span class="hljs-string">"On branch "</span> + refs.headBranchName(),
                         listing(<span class="hljs-string">"Untracked files:"</span>, untracked()),
                         listing(<span class="hljs-string">"Unmerged paths:"</span>, index.conflictedPaths()),
                         listing(<span class="hljs-string">"Changes to be committed:"</span>, toBeCommitted()),
                         listing(<span class="hljs-string">"Changes not staged for commit:"</span>, notStagedForCommit())])
        .join(<span class="hljs-string">"\n"</span>);
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-296">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-296">&#182;</a>
              </div>
              <h2 id="running-gitlet-js-as-a-script">Running gitlet.js as a script</h2>

            </div>
            
        </li>
        
        
        <li id="section-297">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-297">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-298">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-298">&#182;</a>
              </div>
              <p>Gitlet can be used from the command line.  For example, executing
<code>node gitlet.js commit -m woo</code> would commit to the current repo
with the message “woo”.</p>

            </div>
            
        </li>
        
        
        <li id="section-299">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-299">&#182;</a>
              </div>
              <p><strong>parseOptions()</strong> takes the <code>process.argv</code> object passed when
gitlet.js is run as a script. It returns an object that contains
the parsed parameters to be formed into a Gitlet command.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> parseOptions = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(argv)</span> {</span>
  <span class="hljs-keyword">var</span> name;
  <span class="hljs-keyword">return</span> argv.reduce(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(opts, arg)</span> {</span>
    <span class="hljs-keyword">if</span> (arg.match(<span class="hljs-string">"^-"</span>)) {
      name = arg.replace(<span class="hljs-regexp">/^-+/</span>, <span class="hljs-string">""</span>);
      opts[name] = <span class="hljs-literal">true</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (name !== <span class="hljs-literal">undefined</span>) {
      opts[name] = arg;
      name = <span class="hljs-literal">undefined</span>;
    } <span class="hljs-keyword">else</span> {
      opts._.push(arg);
    }

    <span class="hljs-keyword">return</span> opts;
  }, { _: [] });
};</pre></div></div>
            
        </li>
        
        
        <li id="section-300">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-300">&#182;</a>
              </div>
              <p><strong>runCli()</strong> takes the <code>process.argv</code> object passed when gitlet.js
is run as a script.  It parses the command line arguments, runs the
corresponding Gitlet command and returns the string returned by the
command.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> runCli = module.exports.runCli = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(argv)</span> {</span>
  <span class="hljs-keyword">var</span> opts = parseOptions(argv);
  <span class="hljs-keyword">var</span> commandFnName = opts._[<span class="hljs-number">2</span>].replace(<span class="hljs-regexp">/-/g</span>, <span class="hljs-string">"_"</span>);
  <span class="hljs-keyword">var</span> fn = gitlet[commandFnName];
  <span class="hljs-keyword">var</span> commandArgs = opts._.slice(<span class="hljs-number">3</span>);
  <span class="hljs-keyword">while</span> (commandArgs.length &lt; fn.length - <span class="hljs-number">1</span>) {
    commandArgs.push(<span class="hljs-literal">undefined</span>);
  }
  <span class="hljs-keyword">return</span> fn.apply(gitlet, commandArgs.concat(opts));
};</pre></div></div>
            
        </li>
        
        
        <li id="section-301">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-301">&#182;</a>
              </div>
              <p>If <code>gitlet.js</code> is run as a script, pass the <code>process.argv</code> array of
script arguments to <code>runCli()</code> so they can be used to run a Gitlet
command.  Print the return value of the Gitlet command.  If the
Gitlet command throws, print the error message.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">if</span> (<span class="hljs-built_in">require</span>.main === module) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">var</span> result = runCli(process.argv);
    <span class="hljs-keyword">if</span> (result !== <span class="hljs-literal">undefined</span>) {
      console.log(result);
    }
  } <span class="hljs-keyword">catch</span> (e) {
    console.log(e);
  }
}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
